<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dante's Rings: A Future Vibrant Self Adventure</title>
    
    <link rel="apple-touch-icon" href="Dante_App_Logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <style>
        /* --- DESIGN TOKENS --- */
        :root {
            --roblox-blue: #00A2FF;
            --roblox-green: #00E676;
            --vibrant-pink: #FF1493;
            --vibrant-yellow: #FFD700;
            --ui-glass: rgba(0, 0, 0, 0.65);
            --ui-border: rgba(255, 255, 255, 0.3);
            --text-glow: 0 0 15px rgba(0, 162, 255, 0.8);
        }

        /* --- WORLD ARCHITECTURE --- */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000 url('Roblox_Bg.jpg') no-repeat center center fixed;
            background-size: cover;
            color: white;
            font-family: 'Avenir Next', 'Chalkboard SE', 'Comic Sans MS', sans-serif;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            width: 100vw;
            user-select: none;
            -webkit-user-select: none;
            transition: background 2s ease-in-out;
        }

        /* ROBLOX CLOUDS */
        .cloud-drift {
            position: absolute;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 15px;
            z-index: 1;
            pointer-events: none;
            filter: blur(1.5px);
        }
        @keyframes driftAnim {
            from { transform: translateX(-450px); }
            to { transform: translateX(120vw); }
        }

        /* --- UI HUD (TOP BAR) --- */
        #production-hud {
            height: 14vh;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            z-index: 500;
            border-bottom: 2px solid var(--ui-border);
            padding-bottom: 12px;
            box-sizing: border-box;
            box-shadow: 0 5px 25px rgba(0,0,0,0.6);
        }

        #world-name-display {
            font-size: clamp(20px, 5vw, 30px);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--roblox-blue);
            text-shadow: var(--text-glow);
        }

        .hud-stats-row {
            display: flex;
            gap: 25px;
            font-size: 18px;
            font-weight: 700;
            margin: 4px 0;
            letter-spacing: 1.5px;
        }

        #meter-container {
            width: 75%;
            height: 14px;
            background: rgba(255, 255, 255, 0.15);
            border: 2.5px solid white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }

        #meter-fill-bar {
            width: 0%;
            height: 100%;
            background: var(--roblox-green);
            box-shadow: 0 0 15px var(--roblox-green);
            transition: width 0.7s cubic-bezier(0.19, 1, 0.22, 1);
        }

        /* --- THE GAME VIEWPORT (ASPECT RATIO PROTECTED) --- */
        #engine-viewport {
            display: flex;
            flex: 1;
            width: 100%;
            justify-content: center;
            align-items: center;
            gap: 15px;
            position: relative;
            z-index: 100;
            padding: 10px;
            box-sizing: border-box;
        }

        .engine-sidebar {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            width: 15vw;
            max-width: 90px;
        }

        .sidebar-label {
            font-size: 10px;
            font-weight: 900;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .sidebar-module {
            background: var(--ui-glass);
            border: 4px solid #FFF;
            border-radius: 25px;
            width: 85px;
            height: 85px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 15px 35px rgba(0,0,0,0.7);
        }

        /* DANTE AVATAR - PINNED TO HOLD BOX */
        #dante-avatar-anchor {
            position: absolute;
            top: -85px;
            left: 5px;
            width: 75px;
            height: 75px;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 600;
        }
        #dante-avatar-anchor img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.8));
        }

        /* THE GRID - NO STRETCHING ALLOWED */
        #grid-container {
            position: relative;
            height: 98%;
            aspect-ratio: 10 / 20;
            border: 8px solid #FFF;
            border-radius: 40px;
            background: rgba(0, 0, 0, 0.45);
            overflow: hidden;
            box-shadow: 0 30px 70px rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        canvas#master-render-surface {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* --- PRODUCTION OVERLAYS --- */
        .full-screen-overlay {
            position: absolute;
            inset: 0;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
            box-sizing: border-box;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        #state-gateway { background: linear-gradient(135deg, var(--roblox-blue), #003a5c); }
        #state-notification { background: rgba(0,0,0,0.94); display: none; }

        .native-action-btn {
            padding: 24px 65px;
            background: var(--roblox-green);
            color: white;
            border: 6px solid white;
            border-radius: 70px;
            font-size: 32px;
            font-weight: 900;
            text-transform: uppercase;
            box-shadow: 0 14px 0px #006b1a;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .native-action-btn:active { transform: translateY(8px); box-shadow: 0 6px 0px #006b1a; }

        #win-prize-graphic {
            width: 300px;
            border-radius: 35px;
            border: 8px solid white;
            margin-bottom: 30px;
            display: none;
            box-shadow: 0 25px 60px rgba(0,0,0,0.9);
        }

        /* --- BOTTOM CONTROL BAR (15% HEIGHT) --- */
        #interaction-shelf {
            height: 16vh;
            width: 100%;
            display: flex;
            gap: 40px;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-top: 3px solid var(--ui-border);
            z-index: 500;
        }

        .control-shelf-btn {
            width: 130px;
            height: 100px;
            border-radius: 30px;
            border: 6px solid white;
            background: linear-gradient(to bottom, var(--roblox-blue), #006dad);
            font-size: 48px;
            color: white;
            box-shadow: 0 12px 0px #004d7a;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #mute-toggle-system {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 65px;
            height: 65px;
            background: rgba(255,255,255,0.3);
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2500;
            font-size: 32px;
            backdrop-filter: blur(15px);
            cursor: pointer;
        }
    </style>
</head>

<body onpointerdown="triggerEngineAudioWakeup()">

    <div id="mute-toggle-system" onclick="handleMuteToggle()">ðŸ”Š</div>

    <div class="cloud-drift" style="width:220px; height:65px; top:15%; animation: driftSky 45s linear infinite;"></div>
    <div class="cloud-drift" style="width:320px; height:95px; top:45%; animation: driftSky 62s linear reverse infinite;"></div>

    <div id="state-gateway" class="full-screen-overlay">
        <img src="Dante_App_Logo.png" style="width:240px; margin-bottom:30px; filter: drop-shadow(0 20px 40px rgba(0,0,0,0.6));">
        <h1 style="font-size: 68px; margin: 0; letter-spacing: 5px; text-shadow: 6px 6px 0px rgba(0,0,0,0.4);">DANTE'S RINGS</h1>
        <p style="font-size: 28px; color: #CAF0FF; margin-bottom: 45px;">A Future Vibrant Self Adventure</p>
        <button class="native-action-btn" onclick="requestAdventureSession()">START ADVENTURE</button>
    </div>

    <div id="production-hud">
        <b id="world-name-display">Underwater World</b>
        <div class="hud-stats-row">
            <span>SCORE: <b id="ui-val-score">0</b></span>
            <span>LINES: <b id="ui-val-lines">0</b></span>
        </div>
        <div id="meter-container"><div id="meter-fill-bar"></div></div>
    </div>
    
    <div id="game-viewport">
        <div class="viewport-sidebar">
            <span class="sidebar-label">HOLD</span>
            <div class="sidebar-module">
                <div id="dante-avatar-anchor">
                    <img src="Dante_App_Logo.png" id="dante-sprite">
                </div>
                <canvas id="canvas-hold-module" width="50" height="50"></canvas>
            </div>
        </div>

        <div id="engine-grid-container">
            <canvas id="master-render-surface" width="200" height="400"></canvas>
            
            <div id="state-notification" class="full-screen-overlay">
                <img id="win-prize-graphic" src="Youwin.png">
                <h2 id="ov-msg-title" style="font-size: 56px; color: var(--roblox-blue); margin: 0 0 20px 0;">PAUSED</h2>
                <p id="ov-msg-body" style="font-size:26px; max-width:450px; line-height: 1.6; margin-bottom: 35px;"></p>
                <button class="native-action-btn" id="ov-msg-btn" onclick="executeOverlayTransition()">CONTINUE</button>
            </div>
        </div>

        <div class="viewport-sidebar">
            <span class="sidebar-label">NEXT</span>
            <div class="sidebar-module">
                <canvas id="canvas-next-module" width="50" height="50"></canvas>
            </div>
        </div>
    </div>

    <div id="interaction-shelf">
        <button class="control-shelf-btn" onpointerdown="handlePieceHoldRequest()">ðŸ“¦</button>
        <button class="control-shelf-btn" onpointerdown="handlePieceRotateRequest()">ðŸ”„</button>
    </div>

<script>
/**
 * ========================================================================================
 * DANTE'S RINGS: THE ULTIMATE PRODUCTION ENGINE
 * ========================================================================================
 */

// --- I. CORE CONFIGURATION OBJECT ---
const CONFIG = {
    GEOMETRY: { COLS: 10, ROWS: 20, SCALE: 20 },
    COLORS: [
        null,
        '#FF1493', // 1: Hello Kitty Pink
        '#FFD700', // 2: Hello Kitty Yellow
        '#A020F0', // 3: Pandora Purple
        '#00E5FF', // 4: Sky Cyan
        '#FF4500', // 5: Sun Orange
        '#39FF14', // 6: Jungle Green
        '#FF0000'  // 7: School Red
    ],
    NARRATIVE: [
        "Underwater: Dante learns to breathe beneath the surface of his own feelings.",
        "Pandora: Curiosity opens new colors in Dante's sky.",
        "Minecraft: Dante discovers he can rebuild any pattern he breaks.",
        "Lego World: Dante plays with structure instead of fearing it.",
        "Rainforest: Dante trusts growth he cannot yet see.",
        "Outer Space: Dante finds stillness in the vast unknown.",
        "Jungle: Dante follows instinct, moving piece by piece.",
        "School: Dante realizes every mis-drop is a lesson.",
        "Sun Surface: Dante holds his shape even in the heat.",
        "Dream World: Dante wakes up inside his own imagination."
    ],
    LEVELS: [
        { name: "Underwater World", bg: "rgba(0, 168, 255, 0.4)", target: 30, speed: 1000 },
        { name: "Pandora", bg: "rgba(106, 13, 173, 0.4)", target: 60, speed: 900 },
        { name: "Minecraft", bg: "rgba(124, 252, 0, 0.4)", target: 90, speed: 820 },
        { name: "Legoworld", bg: "rgba(255, 0, 0, 0.4)", target: 120, speed: 750 },
        { name: "Rainforest", bg: "rgba(0, 100, 0, 0.4)", target: 150, speed: 680 },
        { name: "Outer Space", bg: "rgba(0, 0, 34, 0.6)", target: 180, speed: 600 },
        { name: "Jungle", bg: "rgba(34, 139, 34, 0.4)", target: 210, speed: 520 },
        { name: "School", bg: "rgba(47, 79, 79, 0.4)", target: 240, speed: 450 },
        { name: "Sun Surface", bg: "rgba(255, 69, 0, 0.4)", target: 270, speed: 380 },
        { name: "Dream World", bg: "rgba(255, 182, 193, 0.5)", target: 350, speed: 320 }
    ]
};

// --- II. REFS MAP (EXPLICIT DOM BINDINGS) ---
const Refs = {
    canvas: document.getElementById('master-render-surface'),
    ctx: document.getElementById('master-render-surface').getContext('2d'),
    holdCtx: document.getElementById('canvas-hold-module').getContext('2d'),
    nextCtx: document.getElementById('canvas-next-module').getContext('2d'),
    
    overlay: document.getElementById('state-notification'),
    ovTitle: document.getElementById('ov-msg-title'),
    ovBody: document.getElementById('ov-msg-body'),
    ovBtn: document.getElementById('ov-msg-btn'),
    ovWin: document.getElementById('win-prize-graphic'),
    
    score: document.getElementById('ui-val-score'),
    lines: document.getElementById('ui-val-lines'),
    meter: document.getElementById('meter-fill-bar'),
    world: document.getElementById('world-name-display'),
    avatar: document.getElementById('dante-avatar-anchor')
};

// Apply Static Canvas Scalling
Refs.ctx.scale(CONFIG.GEOMETRY.SCALE, CONFIG.GEOMETRY.SCALE);
Refs.holdCtx.scale(12, 12);
Refs.nextCtx.scale(12, 12);

// --- III. AUDIO SUBSYSTEM (.M4A MASTER) ---
const AudioEngine = {
    context: new (window.AudioContext || window.webkitAudioContext)(),
    soundtrack: new Audio('Dantesgamemusic.m4a'),
    unlocked: false,
    muted: false,

    /**
     * Initializes the context to bypass iPad silent-mode blocks.
     */
    async unlock() {
        if (this.unlocked) return;
        if (this.context.state === 'suspended') await this.context.resume();
        this.soundtrack.loop = true;
        this.soundtrack.volume = 0.45;
        this.unlocked = true;
        console.log("AUDIO: Production Soundstream Established.");
    },

    playTheme() { if (!this.muted) this.soundtrack.play().catch(() => {}); },
    pauseTheme() { this.soundtrack.pause(); },

    /**
     * Synthesizes digital tones for high-latency-free SFX.
     */
    playSfx(freq, type, duration) {
        if (this.muted || !this.unlocked) return;
        const osc = this.context.createOscillator();
        const gain = this.context.createGain();
        osc.type = type; 
        osc.frequency.setValueAtTime(freq, this.context.currentTime);
        gain.gain.setValueAtTime(0.12, this.context.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, this.context.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.context.destination);
        osc.start();
        osc.stop(this.context.currentTime + duration);
    }
};

function triggerEngineAudioWakeup() { AudioEngine.unlock(); }
function handleMuteToggle() {
    AudioEngine.muted = !AudioEngine.muted;
    AudioEngine.soundtrack.muted = AudioEngine.muted;
    document.getElementById('mute-toggle-system').innerText = AudioEngine.muted ? 'ðŸ”‡' : 'ðŸ”Š';
}

// --- IV. FX ENGINE: PARTICLES & VIBRANT STREAKS ---
const EffectsEngine = {
    activeParticles: [],
    streakTrail: [], // Stores movement history for the "Vibrant Streak"

    /**
     * Spawns physics particles for line clear explosion.
     */
    spawnExplosion(x, y, color) {
        for (let i = 0; i < 12; i++) {
            this.activeParticles.push({
                x, y,
                vx: (Math.random() - 0.5) * 0.7,
                vy: (Math.random() - 0.5) * 0.7,
                life: 1.0,
                color: color
            });
        }
    },

    /**
     * Buffers the current piece position for the trail effect.
     */
    bufferTrail(matrix, pos) {
        this.streakTrail.push({
            matrix: JSON.parse(JSON.stringify(matrix)),
            pos: { x: pos.x, y: pos.y },
            life: 1.0
        });
        // Limit trail length to 6 frames for performance
        if (this.streakTrail.length > 6) this.streakTrail.shift();
    },

    update() {
        // Update Line Particles
        for (let i = this.activeParticles.length - 1; i >= 0; i--) {
            const p = this.activeParticles[i];
            p.x += p.vx; p.y += p.vy;
            p.life -= 0.035;
            if (p.life <= 0) this.activeParticles.splice(i, 1);
        }
        // Update Trail Decay
        this.streakTrail.forEach(t => t.life -= 0.18);
        this.streakTrail = this.streakTrail.filter(t => t.life > 0);
    },

    render(c) {
        // A. Draw Vibrant Streaks (Behind pieces)
        this.streakTrail.forEach(t => {
            c.globalAlpha = t.life * 0.25;
            t.matrix.forEach((row, y) => row.forEach((val, x) => {
                if (val !== 0) {
                    c.fillStyle = CONFIG.COLORS[val];
                    c.beginPath(); 
                    c.arc(x + t.pos.x + 0.5, y + t.pos.y + 0.5, 0.45, 0, Math.PI * 2); 
                    c.fill();
                }
            }));
        });
        
        // B. Draw Physics Particles
        this.activeParticles.forEach(p => {
            c.globalAlpha = p.life;
            c.fillStyle = p.color;
            c.fillRect(p.x, p.y, 0.18, 0.18);
        });
        c.globalAlpha = 1.0;
    }
};

// --- V. THE CORE GAMEPLAY ENGINE ---
const Game = {
    arena: Array.from({length: CONFIG.GEOMETRY.ROWS}, () => Array(CONFIG.GEOMETRY.COLS).fill(0)),
    player: { pos: {x: 0, y: 0}, matrix: null, score: 0 },
    
    nextPiece: null,
    heldPiece: null,
    canHoldPiece: true,
    linesTotal: 0,
    currentLevel: 0,
    
    paused: true,
    dropCounter: 0,
    lastTime: 0,
    dropInterval: 1000,
    
    shakeStr: 0,

    /**
     * Initializes the full logic reset.
     */
    reset() {
        this.arena.forEach(row => row.fill(0));
        this.linesTotal = 0; 
        this.player.score = 0; 
        this.currentLevel = 0;
        this.heldPiece = null; 
        this.nextPiece = null;
        this.dropInterval = CONFIG.LEVELS[0].speed;
        
        this.refreshHUDDisplay();
        Refs.overlay.style.display = 'none';
        this.paused = false;
        
        this.spawnNewRing();
        AudioEngine.playTheme();
        requestAnimationFrame(this.mainLoop.bind(this));
    },

    /**
     * Pulls the next piece from queue and centers it.
     */
    spawnNewRing() {
        const shapeKeys = 'ILJOTSZ';
        this.player.matrix = this.nextPiece || this.generatePiece(shapeKeys[Math.random() * shapeKeys.length | 0]);
        this.nextPiece = this.generatePiece(shapeKeys[Math.random() * shapeKeys.length | 0]);
        
        this.player.pos.y = 0;
        this.player.pos.x = (CONFIG.GEOMETRY.COLS / 2 | 0) - (this.player.matrix[0].length / 2 | 0);
        this.canHoldPiece = true;
        
        if (this.detectCollision()) {
            AudioEngine.playSfx(150, 'sawtooth', 0.65);
            this.setStateNotification("STACKED OUT!", "Breathe. notice the pattern you're building. Every step is growth.", false);
        }
    },

    generatePiece(type) {
        if (type === 'I') return [[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]];
        if (type === 'L') return [[0,2,0],[0,2,0],[0,2,2]];
        if (type === 'J') return [[0,3,0],[0,3,0],[3,3,0]];
        if (type === 'O') return [[4,4],[4,4]];
        if (type === 'Z') return [[5,5,0],[0,5,5],[0,0,0]];
        if (type === 'S') return [[0,6,6],[6,6,0],[0,0,0]];
        if (type === 'T') return [[0,7,0],[7,7,7],[0,0,0]];
    },

    /**
     * Advanced Collision Detection Module.
     */
    detectCollision(arena = this.arena, player = this.player) {
        const [m, o] = [player.matrix, player.pos];
        for (let y = 0; y < m.length; ++y) {
            for (let x = 0; x < m[y].length; ++x) {
                if (m[y][x] !== 0 && (arena[y + o.y] && arena[y + o.y][x + o.x]) !== 0) {
                    return true;
                }
            }
        }
        return false;
    },

    /**
     * Locks piece into the static arena and triggers particle burst.
     */
    mergeIntoArena() {
        this.player.matrix.forEach((row, y) => {
            row.forEach((val, x) => {
                if (val !== 0) {
                    this.arena[y + this.player.pos.y][x + this.player.pos.x] = val;
                    EffectsEngine.spawnExplosion(x + this.player.pos.x, y + this.player.pos.y, CONFIG.COLORS[val]);
                }
            });
        });
    },

    /**
     * Scans for complete rows and triggers Haptic Shake.
     */
    sweepFullRows() {
        let cleared = 0;
        for (let y = this.arena.length - 1; y >= 0; --y) {
            if (this.arena[y].every(cell => cell !== 0)) {
                this.arena.splice(y, 1);
                this.arena.unshift(new Array(CONFIG.GEOMETRY.COLS).fill(0));
                cleared++;
                y++; 
            }
        }
        if (cleared > 0) {
            this.linesTotal += cleared;
            this.player.score += cleared * 10;
            this.shakeStr = 14; // Intensity of Haptic Shake
            AudioEngine.playSfx(523, 'sine', 0.25);
            this.refreshHUDDisplay();
            this.animateDanteJump();
        }
    },

    refreshHUDDisplay() {
        Refs.score.innerText = this.player.score;
        Refs.lines.innerText = this.linesTotal;
        
        const world = CONFIG.LEVELS[this.currentLevel];
        const prevCap = this.currentLevel > 0 ? CONFIG.LEVELS[this.currentLevel - 1].target : 0;
        const progress = Math.max(0, Math.min(100, ((this.linesTotal - prevCap) / (world.target - prevCap) * 100)));
        Refs.meter.style.width = progress + '%';

        // WIN CONDITION CHECK
        if (this.currentLevel === CONFIG.LEVELS.length - 1 && this.linesTotal >= world.target) {
            this.setStateNotification("YOU REACHED DREAM WORLD!", "Dante is home in his own imagination.", true);
            return;
        }
        
        // LEVEL UP CHECK
        if (this.linesTotal >= world.target && this.currentLevel < CONFIG.LEVELS.length - 1) {
            this.currentLevel++;
            this.dropInterval = CONFIG.LEVELS[this.currentLevel].speed;
            Refs.world.innerText = CONFIG.LEVELS[this.currentLevel].name;
            AudioEngine.playSfx(880, 'square', 0.45);
            this.setStateNotification(CONFIG.LEVELS[this.currentLevel].name, CONFIG.STORY[this.currentLevel], false);
        }
    },

    animateDanteJump() {
        Refs.avatar.style.transform = 'scale(1.8) translateY(-40px)';
        setTimeout(() => Refs.avatar.style.transform = 'scale(1) translateY(0)', 350);
    },

    setStateNotification(title, msg, winFlag) {
        this.paused = true;
        AudioEngine.pauseTheme();
        Refs.ovTitle.innerText = title;
        Refs.ovBody.innerText = msg;
        Refs.ovWin.style.display = winFlag ? 'block' : 'none';
        Refs.ovBtn.innerText = winFlag ? "PLAY AGAIN" : (title === "STACKED OUT!" ? "START AGAIN" : "CONTINUE");
        Refs.overlay.style.display = 'flex';
    },

    /**
     * MAIN PHYSICS LOOP (60FPS Target)
     */
    mainLoop(timestamp = 0) {
        if (this.paused) return;
        
        const delta = timestamp - this.lastTime;
        this.lastTime = timestamp;
        
        this.dropCounter += delta;
        if (this.dropCounter > this.dropInterval) {
            this.executeGravityDrop();
            this.dropCounter = 0;
        }
        
        this.performRenderCall();
        requestAnimationFrame(this.mainLoop.bind(this));
    },

    executeGravityDrop() {
        this.player.pos.y++;
        if (this.detectCollision()) {
            this.player.pos.y--;
            this.mergeIntoArena();
            this.sweepFullRows();
            this.spawnNewRing();
            AudioEngine.playSfx(200, 'sine', 0.12);
        }
        // Save history for "Vibrant Streak"
        EffectsEngine.bufferTrail(this.player.matrix, this.player.pos);
    },

    performRenderCall() {
        // 1. Calculate Haptic Shake Translation
        let sx = 0, sy = 0;
        if (this.shakeStr > 0) {
            sx = (Math.random() - 0.5) * this.shakeStr * 0.18;
            sy = (Math.random() - 0.5) * this.shakeStr * 0.18;
            this.shakeStr *= 0.88; // Decay shake intensity
        }

        Refs.ctx.save();
        Refs.ctx.translate(sx, sy);
        
        // 2. Clear Scene & Draw Theme Background
        Refs.ctx.fillStyle = CONFIG.LEVELS[this.currentLevel].bg;
        Refs.ctx.fillRect(0, 0, Refs.canvas.width, Refs.canvas.height);
        
        // 3. Render Roblox Grid Lines
        Refs.ctx.strokeStyle = "rgba(255, 255, 255, 0.15)";
        Refs.ctx.lineWidth = 0.035;
        for(let x=0; x<=CONFIG.GEOMETRY.COLS; x++) { 
            Refs.ctx.beginPath(); Refs.ctx.moveTo(x,0); Refs.ctx.lineTo(x,CONFIG.GEOMETRY.ROWS); Refs.ctx.stroke(); 
        }
        for(let y=0; y<=CONFIG.GEOMETRY.ROWS; y++) { 
            Refs.ctx.beginPath(); Refs.ctx.moveTo(0,y); Refs.ctx.lineTo(CONFIG.GEOMETRY.COLS,y); Refs.ctx.stroke(); 
        }

        // 4. Render Static Arena Rings
        this.renderMatrixToSurface(Refs.ctx, this.arena, {x:0, y:0});
        
        if (this.player.matrix) {
            // 5. Calculate & Render Ghost Piece (Aiming Shadow)
            const shadowCoords = { x: this.player.pos.x, y: this.player.pos.y };
            while (!this.detectCollision(this.arena, { pos: shadowCoords, matrix: this.player.matrix })) {
                shadowCoords.y++;
            }
            shadowCoords.y--;
            this.renderMatrixToSurface(Refs.ctx, this.player.matrix, shadowCoords, true);
            
            // 6. Render Active Falling Piece
            this.renderMatrixToSurface(Refs.ctx, this.player.matrix, this.player.pos);
        }

        // 7. Update and Draw Visual Effects (Trails & Particles)
        EffectsEngine.update();
        EffectsEngine.render(Refs.ctx);
        
        Refs.ctx.restore();

        // 8. Sidebar HUD Rendering
        Refs.nextCtx.clearRect(0,0,5,5); 
        this.renderMatrixToSurface(Refs.nextCtx, this.nextPiece, {x:0, y:0});
        
        Refs.holdCtx.clearRect(0,0,5,5); 
        if (this.heldPiece) {
            this.renderMatrixToSurface(Refs.holdCtx, this.heldPiece, {x:0, y:0});
        }
    },

    renderBlockElement(targetCtx, px, py, colorIndex, ghostMode) {
        targetCtx.globalAlpha = ghostMode ? 0.35 : 1.0;
        const cx = px + 0.5;
        const cy = py + 0.5;
        
        // HELLO KITTY BRAND LOGIC
        // Restricted to Type 1 (Pink) and Type 2 (Yellow) rings. Never shown on ghost aiming shadow.
        if (!ghostMode && (colorIndex === 1 || colorIndex === 2)) {
            targetCtx.fillStyle = CONFIG.COLORS[colorIndex];
            // Left Ear
            targetCtx.beginPath(); targetCtx.arc(cx - 0.25, cy - 0.35, 0.15, 0, Math.PI * 2); targetCtx.fill();
            // Right Ear
            targetCtx.beginPath(); targetCtx.arc(cx + 0.25, cy - 0.35, 0.15, 0, Math.PI * 2); targetCtx.fill();
        }
        
        // PHYSICAL RING BODY
        targetCtx.beginPath();
        targetCtx.arc(cx, cy, 0.42, 0, Math.PI * 2);
        targetCtx.fillStyle = CONFIG.COLORS[colorIndex];
        targetCtx.fill();
        targetCtx.strokeStyle = '#FFFFFF';
        targetCtx.lineWidth = 0.08;
        targetCtx.stroke();
        
        targetCtx.globalAlpha = 1.0;
    },

    renderMatrixToSurface(targetCtx, matrix, offset, isGhost = false) {
        if (!matrix) return;
        matrix.forEach((row, y) => row.forEach((val, x) => {
            if (val !== 0) {
                this.renderBlockElement(targetCtx, x + offset.x, y + offset.y, val, isGhost);
            }
        }));
    }
};

// --- VI. TACTILE INPUT & GESTURE ENGINE (IOS OPTIMIZED) ---
let anchorX = 0, anchorY = 0, swipeDetected = false;

Refs.canvas.addEventListener('touchstart', event => {
    if (Game.paused) return;
    anchorX = event.touches[0].clientX; 
    anchorY = event.touches[0].clientY;
    swipeDetected = false;
}, {passive: false});

Refs.canvas.addEventListener('touchmove', event => {
    if (Game.paused) return; 
    event.preventDefault(); // Lock iPad viewport bounce
    
    const currX = event.touches[0].clientX;
    const currY = event.touches[0].clientY;
    const deltaX = currX - anchorX;
    const deltaY = currY - anchorY;
    
    // Buffer threshold (12px) to prevent accidental micro-movement
    if (Math.abs(deltaX) > 12 || Math.abs(deltaY) > 12) swipeDetected = true;

    // A. Tactile Drag: Horizontal Movement Step
    if (Math.abs(deltaX) > 35) {
        const stepDir = deltaX > 0 ? 1 : -1;
        Game.player.pos.x += stepDir;
        
        if (Game.detectCollision()) {
            Game.player.pos.x -= stepDir;
        } else {
            AudioEngine.playSfx(400, 'sine', 0.045);
        }
        anchorX = currX; // Reset anchor for smooth continuous sliding
    }
    
    // B. Sticky Soft Drop: Drag Down
    if (deltaY > 60) {
        Game.dropInterval = 45; // High speed descent
    }
}, {passive: false});

Refs.canvas.addEventListener('touchend', () => {
    // Treat clean tap as rotation
    if (!Game.paused && !swipeDetected) {
        Game.executeRotateLogic();
    }
    // Restore world drop speed on lift-off
    if (!Game.paused) {
        Game.dropInterval = CONFIG.LEVELS[Game.currentLevel].speed;
    }
});

/**
 * Advanced Rotation Logic with Edge Kicking
 */
Game.executeRotateLogic = function() {
    const originalMatrix = this.player.matrix;
    const originalPosX = this.player.pos.x;
    
    // Transpose and reverse for 90deg CW rotation
    const rotated = this.player.matrix[0].map((_, index) => 
        this.player.matrix.map(col => col[index]).reverse()
    );
    this.player.matrix = rotated;
    
    // Edge-Kicking logic: shift left or right if rotation hits a wall
    let kickOffset = 1;
    while (this.detectCollision()) {
        this.player.pos.x += kickOffset;
        kickOffset = -(kickOffset + (kickOffset > 0 ? 1 : -1));
        if (kickOffset > 4) {
            // Revert rotation if no space found
            this.player.matrix = originalMatrix;
            this.player.pos.x = originalPosX;
            return;
        }
    }
    AudioEngine.playSfx(600, 'sine', 0.05);
};

function handlePieceHoldRequest() {
    if (!Game.canHoldPiece || Game.paused) return;
    
    if (!Game.heldPiece) {
        Game.heldPiece = Game.player.matrix;
        Game.spawnNewRing();
    } else {
        const tempReference = Game.player.matrix;
        Game.player.matrix = Game.heldPiece;
        Game.heldPiece = tempReference;
        Game.player.pos.y = 0;
        Game.player.pos.x = (CONFIG.GEOMETRY.COLS / 2 | 0) - (Game.player.matrix[0].length / 2 | 0);
    }
    Game.canHoldPiece = false;
    AudioEngine.playSfx(300, 'sine', 0.12);
}

function handlePieceRotateRequest() { Game.executeRotateLogic(); }

// --- VII. APP STATE HANDLERS ---
function requestAdventureSession() {
    AudioEngine.unlock();
    document.getElementById('state-gateway').style.display = 'none';
    Game.reset();
}

function executeOverlayTransition() {
    AudioEngine.unlock();
    if (Refs.ovBtn.innerText === "CONTINUE") {
        Refs.overlay.style.display = 'none';
        Game.paused = false;
        AudioEngine.playTheme();
        requestAnimationFrame(Game.mainLoop.bind(Game));
    } else {
        Game.reset();
    }
}

// Global Keyboard Support for Testing
document.addEventListener('keydown', e => {
    if (Game.paused) return;
    if (e.keyCode === 37) { Game.player.pos.x--; if(Game.detectCollision()) Game.player.pos.x++; else AudioEngine.playSfx(400,'sine',0.05); }
    if (e.keyCode === 39) { Game.player.pos.x++; if(Game.detectCollision()) Game.player.pos.x--; else AudioEngine.playSfx(400,'sine',0.05); }
    if (e.keyCode === 40) Game.dropInterval = 45;
    if (e.keyCode === 38 || e.keyCode === 32) Game.executeRotateLogic();
    if (e.keyCode === 72) handlePieceHoldRequest();
});
document.addEventListener('keyup', e => { if (e.keyCode === 40) Game.dropInterval = CONFIG.LEVELS[Game.currentLevel].speed; });

// Initial Pre-render
Game.performRenderCall();
console.log("PRODUCTION ENGINE: DANTE'S RINGS V3.0.0 LOADED.");
</script>
</body>
</html>
