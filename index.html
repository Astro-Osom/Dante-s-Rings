<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dante's Rings: A Future Vibrant Self Adventure</title>
    
    <link rel="apple-touch-icon" href="Dante_App_Logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="Dante_App_Logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="Dante_App_Logo.png">
    <link rel="apple-touch-icon" sizes="167x167" href="Dante_App_Logo.png">
    <meta name="apple-mobile-web-app-title" content="Dante's Rings">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <style>
        /* --- I. PRODUCTION THEME TOKENS --- */
        :root {
            --color-roblox-blue: #00A2FF;
            --color-roblox-green: #00E676;
            --color-candy-highlight: #FFFFFF;
            --color-glass-heavy: rgba(0, 0, 0, 0.75);
            --color-glass-border: rgba(255, 255, 255, 0.35);
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* --- II. UNIVERSAL LAYOUT (THE CENTERING FIX) --- */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000 url('Roblox_Bg.jpg') no-repeat center center fixed;
            background-size: cover;
            color: white;
            font-family: 'Avenir Next', 'Helvetica Neue', 'Segoe UI', sans-serif;
            touch-action: none;
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            user-select: none;
            -webkit-user-select: none;
            transition: background 2.5s ease-in-out;
        }

        /* ENVIRONMENTAL CLOUD DRIFT */
        .sky-drift-element {
            position: absolute;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 15px;
            z-index: 1;
            pointer-events: none;
            filter: blur(1.5px);
        }
        @keyframes driftAnimMain {
            from { transform: translateX(-450px); }
            to { transform: translateX(120vw); }
        }

        /* --- III. iOS HUD SHIELD (FIXED TOP - NOTCH PROTECTION) --- */
        #production-header-shield {
            padding-top: calc(var(--safe-area-top) + 12px);
            height: 18vh;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.55);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            z-index: 4000;
            border-bottom: 2.5px solid var(--color-glass-border);
            box-shadow: 0 5px 35px rgba(0,0,0,0.6);
            box-sizing: border-box;
        }

        #world-label-display {
            font-size: clamp(22px, 7vw, 36px);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: var(--color-roblox-blue);
            text-shadow: 0 0 15px rgba(0, 162, 255, 0.8);
        }

        .hud-stats-container {
            display: flex;
            gap: 30px;
            font-size: 18px;
            font-weight: 700;
            margin: 6px 0 12px 0;
            letter-spacing: 1.5px;
        }

        #progress-track-bg {
            width: 75%;
            height: 12px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }

        #progress-meter-fill {
            width: 0%;
            height: 100%;
            background: var(--color-roblox-green);
            box-shadow: 0 0 15px var(--color-roblox-green);
            transition: width 0.7s cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* --- IV. MASTER Viewport (ZERO-SLOP CENTERING) --- */
        #game-engine-viewport {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 1000;
            padding: 15px;
            box-sizing: border-box;
        }

        /* SIDEBARS: Floating Layers to ensure the Grid stays Dead-Center */
        .engine-sidebar-float {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            width: 85px;
            z-index: 1500;
        }
        #sidebar-hold-container { left: 15px; }
        #sidebar-next-container { right: 15px; }

        .sidebar-tag-title {
            font-size: 10px;
            font-weight: 900;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 1px 1px 2px black;
        }

        .glass-pedestal-module {
            background: var(--color-glass-heavy);
            border: 4.5px solid #FFF;
            border-radius: 25px;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 15px 40px rgba(0,0,0,0.8);
        }

        /* DANTE ICON: MATHEMATICALLY PINNED TO SIDEBAR */
        #dante-avatar-pedestal {
            position: absolute;
            top: -85px;
            width: 75px;
            height: 75px;
            z-index: 2000;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: block;
        }
        #dante-avatar-pedestal img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.8));
        }

        /* THE GRID SURFACE: ASPECT RATIO LOCK (STRETCH-PROOF) */
        #grid-frame-boundary {
            position: relative;
            height: 100%;
            aspect-ratio: 10 / 20; /* Absolute Vertical Fix */
            border: 8px solid #FFF;
            border-radius: 48px;
            background: rgba(0, 0, 0, 0.5);
            overflow: hidden;
            box-shadow: 0 35px 95px rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        canvas#master-production-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* --- V. CINEMATIC OVERLAY SYSTEM (THE SLOP KILLER) --- */
        .native-full-screen-state {
            position: absolute;
            inset: 0;
            z-index: 6000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 45px;
            box-sizing: border-box;
            backdrop-filter: blur(35px);
            -webkit-backdrop-filter: blur(35px);
        }

        #state-intro-menu { background: linear-gradient(135deg, var(--color-roblox-blue), #003657); }
        
        /* Narrative Panel Fix - Guarantees full clearance on continue */
        #state-narrative-panel { 
            background: rgba(0, 0, 0, 0.95); 
            display: none; 
            border: 3.5px solid var(--color-roblox-blue);
        }

        .production-app-btn {
            padding: 24px 75px;
            background: var(--color-roblox-green);
            color: white;
            border: 7px solid white;
            border-radius: 90px;
            font-size: 34px;
            font-weight: 950;
            text-transform: uppercase;
            box-shadow: 0 15px 0px #006b1a;
            cursor: pointer;
            transition: transform 0.1s;
            margin-top: 30px;
        }
        .production-app-btn:active { transform: translateY(8px); box-shadow: 0 7px 0px #006b1a; }

        #win-prize-graphic-asset {
            width: 320px;
            border-radius: 45px;
            border: 8px solid white;
            margin-bottom: 35px;
            display: none;
            box-shadow: 0 25px 65px rgba(0,0,0,0.9);
        }

        /* --- VI. INTERACTION FOOTER (iOS HOME BAR PROTECTED) --- */
        #interaction-control-footer {
            height: 18vh;
            width: 100%;
            display: flex;
            gap: 50px;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-top: 4px solid var(--color-glass-border);
            padding-bottom: var(--safe-area-bottom);
            box-sizing: border-box;
            z-index: 3000;
        }

        .shelf-action-btn {
            width: 140px;
            height: 115px;
            border-radius: 40px;
            border: 6.5px solid white;
            background: linear-gradient(to bottom, var(--color-roblox-blue), #0064a1);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 14px 0px #004b78;
            position: relative;
            overflow: hidden;
        }
        .shelf-action-btn:active { transform: translateY(6px); box-shadow: 0 8px 0px #004b78; }

        /* HELLO KITTY STORE ICON (YOUWIN.PNG) INTEGRATION */
        #kitty-store-img-node {
            width: 95px;
            height: auto;
            pointer-events: none;
            filter: drop-shadow(0 5px 8px rgba(0,0,0,0.5));
        }

        #rotate-icon-node {
            font-size: 56px;
            color: white;
            filter: drop-shadow(0 5px 8px rgba(0,0,0,0.5));
        }

        /* SYSTEM UTILITIES */
        #mute-switch-btn { position: absolute; top: calc(var(--safe-area-top) + 20px); right: 25px; z-index: 10000; font-size: 34px; cursor: pointer; }
        #pause-switch-btn { position: absolute; top: calc(var(--safe-area-top) + 20px); left: 25px; z-index: 10000; font-size: 34px; cursor: pointer; }
    </style>
</head>

<body onpointerdown="handleNativeAudioWake()">

    <div id="mute-switch-btn" onclick="toggleNativeMute()">üîä</div>
    <div id="pause-switch-btn" onclick="requestSystemPause()">‚è∏Ô∏è</div>

    <div class="sky-drift-element" style="width:240px; height:65px; top:18%; animation: driftAnimMain 42s linear infinite;"></div>
    <div class="sky-drift-element" style="width:340px; height:90px; top:48%; animation: driftAnimMain 65s linear reverse infinite;"></div>

    <div id="state-intro-menu" class="native-full-screen-state">
        <div style="background: var(--color-glass-heavy); padding: 50px; border-radius: 60px; border: 5px solid var(--color-glass-border); backdrop-filter: blur(25px);">
            <img src="Dante_App_Logo.png" id="intro-logo" style="width:230px; margin-bottom:35px; filter: drop-shadow(0 20px 45px rgba(0,0,0,0.7));">
            <h1 style="font-size: 72px; margin: 0; letter-spacing: 6px; color: white; text-shadow: 0 0 20px rgba(0,162,255,0.6);">DANTE'S RINGS</h1>
            <p style="font-size: 26px; color: var(--color-roblox-blue); margin-bottom: 50px;">A Future Vibrant Self Adventure</p>
            <button class="production-app-btn" onclick="initiateAdventureSession()">START ADVENTURE</button>
        </div>
    </div>

    <div id="production-header-shield">
        <b id="world-label-display">Underwater World</b>
        <div class="hud-stats-container">
            <span>SCORE: <b id="val-node-score">0</b></span>
            <span>LINES: <b id="val-node-lines">0</b></span>
        </div>
        <div id="progress-track-bg"><div id="progress-meter-fill"></div></div>
    </div>
    
    <div id="game-engine-viewport">
        <div id="sidebar-hold-container" class="engine-sidebar-float">
            <span class="sidebar-tag-title">STORE</span>
            <div class="glass-pedestal-module">
                <div id="dante-avatar-pedestal">
                    <img src="Dante_App_Logo.png" id="dante-sprite-img">
                </div>
                <canvas id="canvas-hold-module" width="50" height="50"></canvas>
            </div>
        </div>

        <div id="grid-frame-boundary">
            <canvas id="master-production-canvas" width="200" height="400"></canvas>
            
            <div id="state-narrative-panel" class="native-full-screen-state">
                <img id="win-prize-graphic-asset" src="Youwin.png">
                <h2 id="msg-ov-label-title" style="font-size: 68px; color: var(--color-roblox-blue); margin: 0 0 25px 0;">LEVEL UP</h2>
                <p id="msg-ov-label-body" style="font-size:32px; max-width:580px; line-height: 1.7; margin-bottom: 55px; color: white;"></p>
                <button class="production-app-btn" id="msg-ov-btn-action" onclick="handleNarrativeClose()">CONTINUE</button>
            </div>
        </div>

        <div id="sidebar-next-container" class="engine-sidebar-float">
            <span class="sidebar-tag-title">NEXT</span>
            <div class="glass-pedestal-module">
                <canvas id="canvas-next-module" width="50" height="50"></canvas>
            </div>
        </div>
    </div>

    <div id="interaction-control-footer">
        <div class="shelf-action-btn" onpointerdown="requestActiveHold()">
            <img src="Youwin.png" id="kitty-store-img-node" alt="Store">
        </div>
        <div class="shelf-action-btn" onpointerdown="requestActiveRotate()">
            <span id="rotate-icon-node">üîÑ</span>
        </div>
    </div>

<script>
/**
 * ========================================================================================
 * DANTE'S RINGS: THE DEFINITIVE MASTER PRODUCTION ENGINE
 * ========================================================================================
 */

// --- I. MASTER DATA & ROADMAP CONFIG (MODULE A) ---
const MasterConfig = {
    GridGeometry: { COLS: 10, ROWS: 20, SCALE: 20 },
    ColorPalette: [
        null,
        '#FFB7C5', // 1: Cherry Blossom
        '#FFDAB9', // 2: Peach Puff
        '#E6E6FA', // 3: Periwinkle
        '#BFFFD9', // 4: Mint Jewel
        '#FF69B4', // 5: Rose Neon
        '#87CEEB', // 6: Sky Jewel
        '#FFD700'  // 7: Gold Nugget
    ],
    NarrativeLessons: [
        "LEVEL 1 TUTORIAL: Breathe beneath the surface. Drag to move. Tap to Spin. Store rings in the Kitty button. Clear 10 to evolve.",
        "Pandora: Dante discovers curiosity. The patterns of self become more colorful.",
        "Minecraft: Dante learns he can rebuild anything he breaks, piece by piece.",
        "Legoworld: Dante finds joy in play. Structure is his foundation.",
        "Rainforest: Dante trusts growth he cannot see yet. Keep ascending.",
        "Outer Space: Dante finds stillness in the vast unknown.",
        "Jungle: Dante follows instinct. He moves with nature, not against it.",
        "School: Dante realizes every mis-drop is a lesson to be mastered.",
        "Sun Surface: Dante holds his shape in the high heat of transformation.",
        "Dream World: Dante wakes up inside his own imagination. The Self is complete."
    ],
    AdventureWorlds: [
        { name: "Underwater World", bg: "rgba(0, 168, 255, 0.4)", target: 10, speed: 1000 },
        { name: "Pandora", bg: "rgba(106, 13, 173, 0.4)", target: 60, speed: 940 },
        { name: "Minecraft", bg: "rgba(124, 252, 0, 0.4)", target: 90, speed: 880 },
        { name: "Legoworld", bg: "rgba(255, 0, 0, 0.4)", target: 120, speed: 820 },
        { name: "Rainforest", bg: "rgba(0, 100, 0, 0.4)", target: 150, speed: 750 },
        { name: "Outer Space", bg: "rgba(0, 0, 34, 0.6)", target: 180, speed: 680 },
        { name: "Jungle", bg: "rgba(34, 139, 34, 0.4)", target: 210, speed: 600 },
        { name: "School", bg: "rgba(47, 79, 79, 0.4)", target: 240, speed: 520 },
        { name: "Sun Surface", bg: "rgba(255, 69, 0, 0.4)", target: 270, speed: 450 },
        { name: "Dream World", bg: "rgba(255, 182, 193, 0.5)", target: 350, speed: 400 }
    ]
};

// --- II. PRODUCTION REFS (MODULE B) ---
const SystemRefs = {
    canvas: document.getElementById('master-production-canvas'),
    ctx: document.getElementById('master-production-canvas').getContext('2d'),
    holdCtx: document.getElementById('canvas-hold-module').getContext('2d'),
    nextCtx: document.getElementById('canvas-next-module').getContext('2d'),
    
    overlayPanel: document.getElementById('state-narrative-panel'),
    ovTitle: document.getElementById('msg-ov-label-title'),
    ovBody: document.getElementById('msg-ov-label-body'),
    ovBtn: document.getElementById('msg-ov-btn-action'),
    ovWinImg: document.getElementById('win-prize-graphic-asset'),
    
    scoreText: document.getElementById('val-node-score'),
    linesText: document.getElementById('val-node-lines'),
    meterFill: document.getElementById('progress-meter-fill'),
    worldDisplay: document.getElementById('world-label-display'),
    avatarPedestal: document.getElementById('dante-avatar-anchor')
};

// Apply Hardware Pixel Scaling
SystemRefs.ctx.scale(MasterConfig.GridGeometry.SCALE, MasterConfig.GridGeometry.SCALE);
SystemRefs.holdCtx.scale(12, 12);
SystemRefs.nextCtx.scale(12, 12);

// --- III. NATIVE AUDIO ENGINE (MODULE C) ---
const NativeAudioController = {
    audioContext: new (window.AudioContext || window.webkitAudioContext)(),
    soundtrack: new Audio('Dantesgamemusic.m4a'),
    isUnlocked: false,
    isMuted: false,

    async unlock() {
        if (this.isUnlocked) return;
        if (this.audioContext.state === 'suspended') await this.audioContext.resume();
        this.soundtrack.loop = true;
        this.soundtrack.volume = 0.45;
        this.isUnlocked = true;
    },

    playTheme() { if (!this.isMuted) this.soundtrack.play().catch(e => {}); },
    pauseTheme() { this.soundtrack.pause(); },

    playTonalSfx(freq, wave, dur) {
        if (this.isMuted || !this.isUnlocked) return;
        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();
        oscillator.type = wave; oscillator.frequency.setValueAtTime(freq, this.audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.15, this.audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.0001, this.audioContext.currentTime + dur);
        oscillator.connect(gainNode); gainNode.connect(this.audioContext.destination);
        oscillator.start(); oscillator.stop(this.audioContext.currentTime + dur);
    }
};

function handleNativeAudioWake() { NativeAudioController.unlock(); }
function toggleNativeMute() {
    NativeAudioController.isMuted = !NativeAudioController.isMuted;
    NativeAudioController.soundtrack.muted = NativeAudioController.isMuted;
    document.getElementById('mute-switch-btn').innerText = NativeAudioController.isMuted ? 'üîá' : 'üîä';
}

// --- IV. FX PIPELINE: SUGAR PARTICLES & VIBRANT STREAKS (MODULE D) ---
const FXModule = {
    particles: [],
    streakBuffer: [],

    spawnClearBurst(x, y, color) {
        for (let i = 0; i < 18; i++) {
            this.particles.push({
                x, y, vx: (Math.random() - 0.5) * 1.1, vy: (Math.random() - 0.5) * 1.1,
                life: 1.0, color
            });
        }
    },

    pushStreakFrame(matrix, pos) {
        this.streakBuffer.push({
            m: JSON.parse(JSON.stringify(matrix)),
            p: { x: pos.x, y: pos.y },
            life: 1.0
        });
        if (this.streakBuffer.length > 8) this.streakBuffer.shift();
    },

    update() {
        for (let i = this.particles.length - 1; i >= 0; i--) {
            const p = this.particles[i];
            p.x += p.vx; p.y += p.vy; p.life -= 0.04;
            if (p.life <= 0) this.particles.splice(i, 1);
        }
        this.streakBuffer.forEach(t => t.life -= 0.16);
        this.streakBuffer = this.streakBuffer.filter(t => t.life > 0);
    },

    render(targetCtx) {
        // Draw Vibrant Streak (Ghost History)
        this.streakBuffer.forEach(t => {
            targetCtx.globalAlpha = t.life * 0.22;
            t.m.forEach((row, y) => row.forEach((val, x) => {
                if (val !== 0) {
                    targetCtx.fillStyle = MasterConfig.ColorPalette[val];
                    targetCtx.beginPath(); targetCtx.arc(x + t.p.x + 0.5, y + t.p.y + 0.5, 0.45, 0, Math.PI * 2); targetCtx.fill();
                }
            }));
        });
        // Draw Explosion Physics
        this.particles.forEach(p => {
            targetCtx.globalAlpha = p.life;
            targetCtx.fillStyle = p.color;
            targetCtx.fillRect(p.x, p.y, 0.18, 0.18);
        });
        targetCtx.globalAlpha = 1.0;
    }
};

// --- V. THE CORE GAME ENGINE CONTROLLER (MODULE E) ---
const CoreEngine = {
    arena: Array.from({length: MasterConfig.GridGeometry.ROWS}, () => Array(MasterConfig.GridGeometry.COLS).fill(0)),
    activePlayer: { pos: {x: 0, y: 0}, matrix: null, score: 0 },
    
    pieceNext: null,
    pieceHeld: null,
    isHoldOk: true,
    linesClearedTotal: 0,
    currentLevelIndex: 0,
    
    isSystemPaused: true,
    frameDropTimer: 0,
    timestampLast: 0,
    activeInterval: 1000,
    
    // LOCK DELAY SUBSYSTEM: For sliding pieces under ledges
    lockTimerActive: 0,
    LOCK_DELAY_DURATION: 500,

    hapticShakeStr: 0,

    /**
     * Initializes engine.
     */
    reset() {
        this.arena.forEach(row => row.fill(0));
        this.linesClearedTotal = 0; this.activePlayer.score = 0; this.currentLevelIndex = 0;
        this.pieceHeld = null; this.pieceNext = null;
        this.activeInterval = MasterConfig.AdventureWorlds[0].speed;
        
        this.updateHUD();
        SystemRefs.overlayPanel.style.display = 'none';
        this.isSystemPaused = false;
        
        this.spawnNewPiece();
        NativeAudioController.playTheme();
        requestAnimationFrame(this.mainTick.bind(this));
    },

    spawnNewPiece() {
        const types = 'ILJOTSZ';
        this.activePlayer.matrix = this.pieceNext || this.generateShape(types[Math.floor(Math.random() * types.length)]);
        this.pieceNext = this.generateShape(types[Math.floor(Math.random() * types.length)]);
        
        this.activePlayer.pos.y = 0;
        this.activePlayer.pos.x = (MasterConfig.GridGeometry.COLS / 2 | 0) - (this.activePlayer.matrix[0].length / 2 | 0);
        this.isHoldOk = true;
        
        if (this.detectCollision()) {
            NativeAudioController.playTonalSfx(150, 'sawtooth', 0.8);
            this.triggerUINotification("STACKED OUT!", "Breathe. notice the pattern you're building.", false);
        }
    },

    generateShape(type) {
        if (type === 'I') return [[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]];
        if (type === 'L') return [[0,2,0],[0,2,0],[0,2,2]];
        if (type === 'J') return [[0,3,0],[0,3,0],[3,3,0]];
        if (type === 'O') return [[4,4],[4,4]];
        if (type === 'Z') return [[5,5,0],[0,5,5],[0,0,0]];
        if (type === 'S') return [[0,6,6],[6,6,0],[0,0,0]];
        if (type === 'T') return [[0,7,0],[7,7,7],[0,0,0]];
    },

    detectCollision(targetArena = this.arena, targetPlayer = this.activePlayer) {
        const [m, o] = [targetPlayer.matrix, targetPlayer.pos];
        for (let y = 0; y < m.length; ++y) {
            for (let x = 0; x < m[y].length; ++x) {
                if (m[y][x] !== 0 && (targetArena[y + o.y] && targetArena[y + o.y][x + o.x]) !== 0) return true;
            }
        }
        return false;
    },

    commitActivePiece() {
        this.activePlayer.matrix.forEach((row, y) => row.forEach((val, x) => {
            if (val !== 0) {
                this.arena[y + this.activePlayer.pos.y][x + this.activePlayer.pos.x] = val;
                FXModule.spawnClearBurst(x + this.activePlayer.pos.x, y + this.activePlayer.pos.y, MasterConfig.ColorPalette[val]);
            }
        }));
    },

    sweepGridLines() {
        let clearedCount = 0;
        for (let y = this.arena.length - 1; y >= 0; --y) {
            if (this.arena[y].every(cell => cell !== 0)) {
                this.arena.splice(y, 1);
                this.arena.unshift(new Array(MasterConfig.GridGeometry.COLS).fill(0));
                clearedCount++; y++; 
            }
        }
        if (clearedCount > 0) {
            this.linesClearedTotal += clearedCount;
            this.activePlayer.score += clearedCount * 10;
            this.hapticShakeStr = 22; 
            NativeAudioController.playTonalSfx(523, 'sine', 0.25);
            this.updateHUD();
            this.performDanteJump();
        }
    },

    updateHUD() {
        SystemRefs.scoreText.innerText = this.activePlayer.score;
        SystemRefs.linesText.innerText = this.linesClearedTotal;
        
        const worldData = MasterConfig.AdventureWorlds[this.currentLevelIndex];
        const prevTarget = this.currentLevelIndex > 0 ? MasterConfig.AdventureWorlds[this.currentLevelIndex - 1].target : 0;
        const percentage = Math.max(0, Math.min(100, ((this.linesClearedTotal - prevTarget) / (worldData.target - prevTarget) * 100)));
        SystemRefs.meterFill.style.width = percentage + '%';

        // NARRATIVE LEVEL UP CHECK (Every 10 lines for onboarding)
        if (this.currentLevelIndex === MasterConfig.AdventureWorlds.length - 1 && this.linesClearedTotal >= worldData.target) {
            this.triggerUINotification("DREAM WORLD REACHED!", "Dante is home in his imagination.", true);
            return;
        }
        
        if (this.linesClearedTotal >= worldData.target && this.currentLevelIndex < MasterConfig.AdventureWorlds.length - 1) {
            this.currentLevelIndex++;
            this.activeInterval = MasterConfig.AdventureWorlds[this.currentLevelIndex].speed;
            SystemRefs.worldDisplay.innerText = MasterConfig.AdventureWorlds[this.currentLevelIndex].name;
            NativeAudioController.playTonalSfx(880, 'square', 0.5);
            this.triggerUINotification(MasterConfig.AdventureWorlds[this.currentLevelIndex].name, MasterConfig.NarrativeLessons[this.currentLevelIndex], false);
        }
    },

    performDanteJump() {
        SystemRefs.avatarPedestal.style.transform = 'scale(2.3) translateY(-65px)';
        setTimeout(() => SystemRefs.avatarPedestal.style.transform = 'scale(1) translateY(0)', 450);
    },

    triggerUINotification(title, body, winFlag) {
        this.isSystemPaused = true;
        NativeAudioController.pauseTheme();
        SystemRefs.ovTitle.innerText = title;
        SystemRefs.ovBody.innerText = body;
        SystemRefs.ovWinImg.style.display = winFlag ? 'block' : 'none';
        SystemRefs.ovBtn.innerText = winFlag ? "PLAY AGAIN" : (title === "STACKED OUT!" ? "RESTART" : "CONTINUE");
        SystemRefs.overlayPanel.style.display = 'flex';
    },

    /**
     * MAIN ENGINE LOOP (60FPS Target)
     */
    mainTick(timestamp = 0) {
        if (this.isSystemPaused) return;
        
        const delta = timestamp - this.timestampLast;
        this.timestampLast = timestamp;
        
        this.frameDropTimer += delta;
        if (this.frameDropTimer > this.activeInterval) {
            this.processGravityStep();
            this.frameDropTimer = 0;
        }
        
        this.fullSceneRender();
        requestAnimationFrame(this.mainTick.bind(this));
    },

    processGravityStep() {
        this.activePlayer.pos.y++;
        if (this.detectCollision()) {
            this.activePlayer.pos.y--;
            
            // LOCK DELAY SUBSYSTEM
            if (this.lockTimerActive === 0) {
                this.lockTimerActive = Date.now();
            }
            
            const elapsed = Date.now() - this.lockTimerActive;
            if (elapsed > this.LOCK_DELAY_DURATION) {
                this.commitActivePiece();
                this.sweepGridLines();
                this.spawnNewPiece();
                this.lockTimerActive = 0;
                NativeAudioController.playTonalSfx(200, 'sine', 0.15);
            }
        } else {
            this.lockTimerActive = 0; 
        }
        FXModule.pushStreakFrame(this.activePlayer.matrix, this.activePlayer.pos);
    },

    fullSceneRender() {
        // 1. Calculate Haptic Shake
        let ox = 0, oy = 0;
        if (this.hapticShakeStr > 0) {
            ox = (Math.random() - 0.5) * this.hapticShakeStr * 0.28;
            oy = (Math.random() - 0.5) * this.hapticShakeStr * 0.28;
            this.hapticShakeStr *= 0.85;
        }

        SystemRefs.ctx.save();
        SystemRefs.ctx.translate(ox, oy);
        
        // 2. Clear Scene & Draw Theme Backdrop
        SystemRefs.ctx.fillStyle = MasterConfig.AdventureWorlds[this.currentLevelIndex].bg;
        SystemRefs.ctx.fillRect(0, 0, SystemRefs.canvas.width, SystemRefs.canvas.height);
        
        // 3. Grid Lines
        SystemRefs.ctx.strokeStyle = "rgba(255, 255, 255, 0.22)";
        SystemRefs.ctx.lineWidth = 0.05;
        for(let x=0; x<=MasterConfig.GridGeometry.COLS; x++) { 
            SystemRefs.ctx.beginPath(); SystemRefs.ctx.moveTo(x,0); SystemRefs.ctx.lineTo(x,MasterConfig.GridGeometry.ROWS); SystemRefs.ctx.stroke(); 
        }
        for(let y=0; y<=MasterConfig.GridGeometry.ROWS; y++) { 
            SystemRefs.ctx.beginPath(); SystemRefs.ctx.moveTo(0,y); SystemRefs.ctx.lineTo(MasterConfig.GridGeometry.COLS,y); SystemRefs.ctx.stroke(); 
        }

        // 4. Static Content Render
        this.renderMatrix(SystemRefs.ctx, this.arena, {x:0, y:0});
        
        if (this.activePlayer.matrix) {
            // 5. Aiming Shadow
            const ghostPos = { x: this.activePlayer.pos.x, y: this.activePlayer.pos.y };
            while (!this.detectCollision(this.arena, { pos: ghostPos, matrix: this.activePlayer.matrix })) {
                ghostPos.y++;
            }
            ghostPos.y--;
            this.renderMatrix(SystemRefs.ctx, this.activePlayer.matrix, ghostPos, true);
            
            // 6. Active Falling piece
            this.renderMatrix(SystemRefs.ctx, this.activePlayer.matrix, this.activePlayer.pos);
        }

        // 7. Visual FX Pipeline
        FXModule.update();
        FXModule.render(SystemRefs.ctx);
        
        SystemRefs.ctx.restore();

        // 8. Sidebar Previews
        SystemRefs.nextCtx.clearRect(0,0,5,5); 
        this.renderMatrix(SystemRefs.nextCtx, this.pieceNext, {x:0, y:0});
        
        SystemRefs.holdCtx.clearRect(0,0,5,5); 
        if (this.pieceHeld) {
            this.renderMatrix(SystemRefs.holdCtx, this.pieceHeld, {x:0, y:0});
        }
    },

    renderBlockCandy(c, px, py, colorIdx, isGhost) {
        c.globalAlpha = isGhost ? 0.35 : 1.0;
        const cx = px + 0.5; const cy = py + 0.5;
        const baseColor = MasterConfig.ColorPalette[colorIdx];
        
        // HELLO KITTY EAR RENDERING (On Type 1 and 2 Rings)
        if (!isGhost && (colorIdx === 1 || colorIdx === 2)) {
            c.fillStyle = baseColor;
            c.beginPath(); c.arc(cx - 0.25, cy - 0.35, 0.15, 0, Math.PI * 2); c.fill();
            c.beginPath(); c.arc(cx + 0.25, cy - 0.35, 0.15, 0, Math.PI * 2); c.fill();
        }
        
        // CORE RING JEWELRY
        c.beginPath(); c.arc(cx, cy, 0.44, 0, Math.PI * 2);
        
        // Triple-Radial Candy Crush Gradient
        const gradient = c.createRadialGradient(cx-0.1, cy-0.1, 0.05, cx, cy, 0.48);
        gradient.addColorStop(0, 'white'); // Gloss
        gradient.addColorStop(0.3, baseColor);
        gradient.addColorStop(1, 'rgba(0,0,0,0.4)'); // Deep shadow
        
        c.fillStyle = gradient;
        c.fill();
        c.strokeStyle = 'white';
        c.lineWidth = 0.08;
        c.stroke();
        
        c.globalAlpha = 1.0;
    },

    renderMatrix(ctxTarget, matrixData, offsetPos, asGhost = false) {
        if (!matrixData) return;
        matrixData.forEach((row, y) => row.forEach((val, x) => {
            if (val !== 0) this.renderBlockCandy(ctxTarget, x + offsetPos.x, y + offsetPos.y, val, asGhost);
        }));
    }
};

// --- VI. NATIVE INTERFACE: GESTURE ENGINE (MODULE F) ---
let startX = 0, startY = 0, isSwipeActive = false;

SystemRefs.canvas.addEventListener('touchstart', e => {
    if (CoreEngine.isSystemPaused) return;
    startX = e.touches[0].clientX; startY = e.touches[0].clientY;
    isSwipeActive = false;
}, {passive: false});

SystemRefs.canvas.addEventListener('touchmove', e => {
    if (CoreEngine.isSystemPaused) return; e.preventDefault();
    const currX = e.touches[0].clientX; const currY = e.touches[0].clientY;
    const diffX = currX - startX; const diffY = currY - startY;
    
    if (Math.abs(diffX) > 12 || Math.abs(diffY) > 12) isSwipeActive = true;

    // Movement Trigger
    if (Math.abs(diffX) > 40) {
        const direction = diffX > 0 ? 1 : -1;
        CoreEngine.activePlayer.pos.x += direction;
        if (CoreEngine.detectCollision()) {
            CoreEngine.activePlayer.pos.x -= direction;
        } else {
            NativeAudioController.playTonalSfx(420, 'sine', 0.05);
        }
        startX = currX;
    }
    // Descent Trigger (Pull Down)
    if (diffY > 65) CoreEngine.activeInterval = 45;
}, {passive: false});

SystemRefs.canvas.addEventListener('touchend', () => {
    if (!CoreEngine.isSystemPaused && !isSwipeActive) {
        performRotateAction();
    }
    if (!CoreEngine.isSystemPaused) {
        CoreEngine.activeInterval = MasterConfig.AdventureWorlds[CoreEngine.currentLevelIndex].speed;
    }
});

function requestSystemPause() {
    if (CoreEngine.isSystemPaused) return;
    CoreEngine.triggerUINotification("PAUSED", "Reconnect with your Future Vibrant Self.", false);
}

function requestActiveHold() {
    if (!CoreEngine.isHoldOk || CoreEngine.isSystemPaused) return;
    if (!CoreEngine.pieceHeld) {
        CoreEngine.pieceHeld = CoreEngine.activePlayer.matrix;
        CoreEngine.spawnNewPiece();
    } else {
        const tempReference = CoreEngine.activePlayer.matrix;
        CoreEngine.activePlayer.matrix = CoreEngine.pieceHeld;
        CoreEngine.pieceHeld = tempReference;
        CoreEngine.activePlayer.pos.y = 0;
        CoreEngine.activePlayer.pos.x = (MasterConfig.GridGeometry.COLS / 2 | 0) - (CoreEngine.activePlayer.matrix[0].length / 2 | 0);
    }
    CoreEngine.isHoldOk = false;
    NativeAudioController.playTonalSfx(300, 'sine', 0.15);
}

function performRotateAction() {
    const oldMatrix = CoreEngine.activePlayer.matrix;
    const oldPosX = CoreEngine.activePlayer.pos.x;
    const rotated = CoreEngine.activePlayer.matrix[0].map((_, i) => CoreEngine.activePlayer.matrix.map(c => c[i]).reverse());
    CoreEngine.activePlayer.matrix = rotated;
    
    let kickAttempt = 1;
    while (CoreEngine.detectCollision()) {
        CoreEngine.activePlayer.pos.x += kickAttempt;
        kickAttempt = -(kickAttempt + (kickAttempt > 0 ? 1 : -1));
        if (kickAttempt > 4) {
            CoreEngine.activePlayer.matrix = oldMatrix;
            CoreEngine.activePlayer.pos.x = oldPosX;
            return;
        }
    }
    NativeAudioController.playTonalSfx(600, 'sine', 0.05);
}
function requestActiveRotate() { performRotateAction(); }

// --- VII. APPLICATION STATE TRANSITIONS ---
function initiateAdventureSession() {
    NativeAudioController.unlock();
    document.getElementById('state-intro-menu').style.display = 'none';
    CoreEngine.reset();
}

function handleNarrativeClose() {
    NativeAudioController.unlock();
    if (SystemRefs.ovBtn.innerText === "CONTINUE") {
        SystemRefs.overlayPanel.style.display = 'none';
        CoreEngine.isSystemPaused = false;
        NativeAudioController.playTheme();
        requestAnimationFrame(CoreEngine.mainTick.bind(CoreEngine));
    } else {
        CoreEngine.reset();
    }
}

// Initial Prerender
CoreEngine.fullSceneRender();
console.log("ENGINE V15.0 ACTIVE (SLOP-ZERO DEFINITIVE MASTER).");
</script>
</body>
</html>
