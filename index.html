<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dante's Rings</title>
<link rel="apple-touch-icon" href="Dante_App_Logo.png">
<link rel="apple-touch-icon" sizes="180x180" href="Dante_App_Logo.png">
<meta name="apple-mobile-web-app-title" content="Dante's Rings">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<style>
:root{
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bot:env(safe-area-inset-bottom,0px);
  --acc:#00C8FF;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0}
body{
  overflow:hidden;
  background:#001040;
  color:#fff;
  font-family:'Avenir Next','Helvetica Neue',Arial,sans-serif;
  touch-action:none;user-select:none;-webkit-user-select:none;
  display:flex;flex-direction:column;
  height:100dvh;width:100vw;
  transition:background 1.4s ease;
}
.cloud{position:fixed;pointer-events:none;z-index:0;background:rgba(255,255,255,.14);border-radius:50px;filter:blur(4px)}
@keyframes drift{from{transform:translateX(-300px)}to{transform:translateX(110vw)}}

/* â”€â”€ HUD â”€â”€ */
#hud{
  padding-top:calc(var(--safe-top) + 5px);padding-bottom:7px;
  width:100%;display:flex;flex-direction:column;align-items:center;gap:3px;
  background:rgba(0,0,0,.78);
  backdrop-filter:blur(22px);-webkit-backdrop-filter:blur(22px);
  border-bottom:2px solid rgba(255,255,255,.18);
  box-shadow:0 4px 28px rgba(0,0,0,.55);
  z-index:500;flex-shrink:0;
}
#world-name{
  font-size:clamp(14px,4.2vw,22px);font-weight:900;text-transform:uppercase;
  letter-spacing:3px;color:var(--acc);
  text-shadow:0 0 16px var(--acc);
  transition:color .7s,text-shadow .7s;
}
.hud-row{display:flex;gap:18px;font-size:clamp(10px,2.8vw,14px);font-weight:800;letter-spacing:1px;color:rgba(255,255,255,.88)}
.hud-row b{color:#FFD600;text-shadow:0 0 7px #FFD600}
#prog-wrap{width:74%;height:9px;background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.22);border-radius:20px;overflow:hidden}
#prog-bar{height:100%;width:0%;border-radius:20px;transition:width .5s cubic-bezier(.23,1,.32,1),background .8s}

/* â”€â”€ VIEWPORT â”€â”€ */
#viewport{flex:1;min-height:0;display:flex;align-items:center;justify-content:center;position:relative;z-index:10;padding:7px 5px}
.sidebar{position:absolute;display:flex;flex-direction:column;align-items:center;gap:6px;width:68px;z-index:20}
#sb-l{left:5px}
#sb-r{right:5px}
.sb-label{font-size:8px;font-weight:900;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.38)}
.glass-box{
  width:64px;height:64px;background:rgba(0,0,0,.72);
  border:3px solid rgba(255,255,255,.48);border-radius:17px;
  display:flex;align-items:center;justify-content:center;position:relative;
  box-shadow:0 7px 25px rgba(0,0,0,.7),inset 0 1px 0 rgba(255,255,255,.1);
}
#dante-wrap{
  position:absolute;top:-68px;left:50%;transform:translateX(-50%);
  width:60px;height:60px;
  transition:transform .3s cubic-bezier(.175,.885,.32,1.275);z-index:30;
}
#dante-img{width:100%;height:100%;object-fit:contain;filter:drop-shadow(0 5px 12px rgba(0,0,0,.8))}
#dante-mood{position:absolute;bottom:-4px;right:-4px;font-size:17px;line-height:1}

/* â”€â”€ GRID â”€â”€ */
#grid-wrap{
  position:relative;height:100%;aspect-ratio:10/20;
  border:5px solid rgba(255,255,255,.8);border-radius:22px;overflow:hidden;
  box-shadow:0 0 0 2px rgba(255,255,255,.1),0 22px 75px rgba(0,0,0,.9);
}
#gc{width:100%;height:100%;display:block}
#flash{position:absolute;inset:0;pointer-events:none;z-index:15;opacity:0;border-radius:18px;transition:opacity .06s}

/* Pips */
#pips-wrap{position:absolute;top:6px;right:6px;z-index:25;display:flex;flex-direction:column;align-items:center;gap:2px}
#pips-label{font-size:7px;font-weight:900;letter-spacing:1px;color:#FF2D9B;text-transform:uppercase}
.pip{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.1);border:1.5px solid rgba(255,255,255,.28);transition:background .25s,box-shadow .25s}
.pip.on{background:#FF2D9B;box-shadow:0 0 7px #FF2D9B}

/* Stars */
#stars-wrap{position:absolute;top:6px;left:6px;z-index:25;font-size:10px;letter-spacing:1px}

/* Combo / Chain badge */
#badge{
  position:absolute;top:38%;left:50%;
  transform:translate(-50%,-50%) scale(0);
  z-index:50;pointer-events:none;
  font-size:clamp(18px,6.5vw,34px);font-weight:900;text-transform:uppercase;
  letter-spacing:2px;white-space:nowrap;
  text-shadow:0 0 14px currentColor,0 3px 0 rgba(0,0,0,.5);
}
@keyframes badgePop{
  0%  {transform:translate(-50%,-50%) scale(0);opacity:1}
  25% {transform:translate(-50%,-62%) scale(1.25);opacity:1}
  70% {transform:translate(-50%,-67%) scale(1);opacity:1}
  100%{transform:translate(-50%,-88%) scale(.8);opacity:0}
}

/* World transition */
#wflash{
  position:fixed;inset:0;z-index:4000;display:none;
  flex-direction:column;align-items:center;justify-content:center;
  text-align:center;padding:30px;
  font-size:clamp(28px,8.5vw,58px);font-weight:900;
  text-transform:uppercase;letter-spacing:4px;color:white;
}
@keyframes wfAnim{0%{opacity:0;transform:scale(.85)}20%{opacity:1;transform:scale(1.04)}70%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(1.08)}}

/* â”€â”€ OVERLAY â”€â”€ */
#overlay{
  position:absolute;inset:0;display:none;
  flex-direction:column;align-items:center;justify-content:center;
  text-align:center;padding:22px;
  background:rgba(0,0,0,.93);
  backdrop-filter:blur(30px);-webkit-backdrop-filter:blur(30px);
  border-radius:19px;z-index:100;
}
#ov-win-img{width:min(190px,72%);border-radius:22px;border:5px solid white;margin-bottom:14px;display:none;box-shadow:0 18px 55px rgba(0,0,0,.8)}
#ov-stars{font-size:30px;letter-spacing:4px;margin-bottom:5px;min-height:34px}
#ov-title{font-size:clamp(20px,6.5vw,40px);font-weight:900;text-transform:uppercase;color:var(--acc);margin:0 0 9px;text-shadow:0 0 16px var(--acc);letter-spacing:2px}
#ov-body{font-size:clamp(11px,3vw,16px);line-height:1.55;color:rgba(255,255,255,.83);max-width:270px;margin:0 0 18px}
#ov-best{font-size:11px;color:#FFD600;font-weight:700;margin-bottom:12px;letter-spacing:1px}
.ov-btn{
  padding:13px 42px;
  background:linear-gradient(135deg,#00FF88,#00c864);
  color:#000;font-weight:900;
  font-size:clamp(15px,4.2vw,21px);text-transform:uppercase;letter-spacing:2px;
  border:4px solid white;border-radius:58px;cursor:pointer;
  box-shadow:0 7px 0 #006b35,0 10px 26px rgba(0,255,136,.28);
  transition:transform .1s,box-shadow .1s;
}
.ov-btn:active{transform:translateY(4px);box-shadow:0 3px 0 #006b35}
#share-btn{margin-top:9px;padding:9px 30px;background:linear-gradient(135deg,#00C8FF,#0064a1);color:#fff;font-weight:800;font-size:clamp(12px,3.2vw,16px);border:3px solid white;border-radius:48px;cursor:pointer;box-shadow:0 5px 0 #003d6b;display:none}
#power-btn{margin-top:9px;padding:9px 30px;background:linear-gradient(135deg,#FF2D9B,#c0006e);color:white;font-weight:900;font-size:clamp(11px,3vw,15px);border:3px solid white;border-radius:48px;cursor:pointer;box-shadow:0 5px 0 #7a004a;display:none}

/* â”€â”€ START SCREEN â”€â”€ */
#start{
  position:fixed;inset:0;z-index:9000;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:linear-gradient(160deg,#08082a 0%,#001838 55%,#08082a 100%);
  padding:20px;text-align:center;
}
.start-card{
  background:rgba(0,0,0,.76);border:4px solid rgba(255,255,255,.23);border-radius:42px;
  padding:32px 26px;max-width:340px;width:100%;backdrop-filter:blur(20px);
  box-shadow:0 28px 75px rgba(0,0,0,.9);
}
#start-logo{width:min(130px,48%);margin-bottom:14px;filter:drop-shadow(0 8px 28px rgba(0,200,255,.5));animation:floatY 3s ease-in-out infinite}
@keyframes floatY{0%,100%{transform:translateY(0)}50%{transform:translateY(-9px)}}
#start-title{font-size:clamp(26px,8.5vw,45px);font-weight:900;letter-spacing:4px;color:white;text-shadow:0 0 25px rgba(0,200,255,.65)}
#start-sub{font-size:clamp(10px,2.8vw,13px);color:#00C8FF;margin:5px 0 8px;letter-spacing:1px}
#start-tagline{font-size:clamp(13px,3.5vw,17px);color:rgba(255,255,255,.75);margin:0 0 22px;font-weight:700;letter-spacing:.5px}
#start-btn{
  padding:17px 52px;
  background:linear-gradient(135deg,#00C8FF,#0064a1);
  color:white;font-weight:900;font-size:clamp(17px,4.8vw,25px);
  text-transform:uppercase;letter-spacing:3px;
  border:5px solid white;border-radius:68px;cursor:pointer;
  box-shadow:0 9px 0 #003d6b,0 13px 38px rgba(0,200,255,.32);
  animation:pulseBtn 2.2s ease-in-out infinite;
}
@keyframes pulseBtn{0%,100%{box-shadow:0 9px 0 #003d6b,0 13px 38px rgba(0,200,255,.28)}50%{box-shadow:0 9px 0 #003d6b,0 13px 52px rgba(0,200,255,.6)}}
#start-btn:active{transform:translateY(5px);box-shadow:0 4px 0 #003d6b;animation:none}
.hints{display:flex;gap:7px;margin-top:18px;justify-content:center;flex-wrap:wrap}
.hint{background:rgba(255,255,255,.09);border:2px solid rgba(255,255,255,.18);border-radius:38px;padding:5px 12px;font-size:10px;font-weight:700;color:rgba(255,255,255,.68)}
#start-best{font-size:12px;color:#FFD600;font-weight:700;margin-top:12px;letter-spacing:1px;min-height:17px}

/* â”€â”€ FOOTER â”€â”€ */
#footer{
  padding-bottom:calc(var(--safe-bot) + 4px);padding-top:5px;
  width:100%;display:flex;justify-content:center;align-items:center;gap:14px;
  background:rgba(0,0,0,.8);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-top:2px solid rgba(255,255,255,.18);
  flex-shrink:0;z-index:500;
}
.fbt{
  width:clamp(78px,23vw,112px);height:clamp(56px,12.5vh,80px);
  border-radius:24px;border:5px solid rgba(255,255,255,.85);
  cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;
  box-shadow:0 7px 0 rgba(0,0,0,.5);transition:transform .1s,box-shadow .1s;
}
.fbt:active{transform:translateY(4px);box-shadow:0 3px 0 rgba(0,0,0,.5)}
.fbt .fl{font-size:8px;font-weight:900;letter-spacing:1.5px;text-transform:uppercase;opacity:.8}
#btn-hold{background:linear-gradient(160deg,#7B2FFF,#4a00b8);box-shadow:0 7px 0 #2a007a,0 0 16px rgba(123,47,255,.32)}
#btn-drop{background:linear-gradient(160deg,#FFD600,#b88a00);box-shadow:0 7px 0 #7a5900,0 0 16px rgba(255,214,0,.32);color:#000}
#btn-rotate{background:linear-gradient(160deg,#FF2D9B,#b8004a);box-shadow:0 7px 0 #7a0030,0 0 16px rgba(255,45,155,.32)}
.rot-icon{font-size:28px;display:inline-block;font-weight:900;line-height:1;transition:transform .3s cubic-bezier(.175,.885,.32,1.275)}
#btn-rotate:active .rot-icon{transform:rotate(90deg)}

/* Sys */
.sys{position:fixed;z-index:8000;font-size:21px;cursor:pointer;background:rgba(0,0,0,.55);border:2px solid rgba(255,255,255,.28);border-radius:50%;width:38px;height:38px;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px)}
#mute-btn{top:calc(var(--safe-top) + 5px);right:11px}
#pause-btn{top:calc(var(--safe-top) + 5px);left:11px}
</style>
</head>
<body onpointerdown="wakeAudio()">

<div class="sys" id="mute-btn" onclick="toggleMute()">ğŸ”Š</div>
<div class="sys" id="pause-btn" onclick="doPause()">â¸</div>

<div class="cloud" style="width:190px;height:52px;top:10%;animation:drift 40s linear infinite"></div>
<div class="cloud" style="width:265px;height:68px;top:36%;animation:drift 56s linear reverse infinite"></div>
<div class="cloud" style="width:150px;height:42px;top:63%;animation:drift 32s linear infinite 6s"></div>

<div id="wflash"></div>

<!-- â•â•â• START SCREEN â•â•â• -->
<div id="start">
  <div class="start-card">
    <img src="Dante_App_Logo.png" id="start-logo" alt="Dante">
    <h1 id="start-title">DANTE'S RINGS</h1>
    <p id="start-sub">A Dante &amp; Coco Adventure</p>
    <p id="start-tagline">10 Worlds. Infinite Rings. One Chain Reaction.</p>
    <button id="start-btn" onclick="startGame()">START ADVENTURE</button>
    <div id="start-best"></div>
    <div class="hints">
      <div class="hint">ğŸ‘† Tap â†’ Rotate</div>
      <div class="hint">ğŸ‘‰ Drag â†’ Move</div>
      <div class="hint">ğŸ‘‡ Drag Down â†’ Drop</div>
    </div>
  </div>
</div>

<!-- â•â•â• HUD â•â•â• -->
<div id="hud">
  <p id="world-name">ğŸŒŠ Underwater World</p>
  <div class="hud-row">
    <span>SCORE <b id="v-score">0</b></span>
    <span>LINES <b id="v-lines">0</b></span>
    <span>BEST <b id="v-best">0</b></span>
  </div>
  <div id="prog-wrap"><div id="prog-bar"></div></div>
</div>

<!-- â•â•â• VIEWPORT â•â•â• -->
<div id="viewport">
  <div class="sidebar" id="sb-l">
    <span class="sb-label">HOLD</span>
    <div class="glass-box">
      <div id="dante-wrap">
        <img src="Dante_App_Logo.png" id="dante-img" alt="Dante">
        <span id="dante-mood">ğŸ˜Š</span>
      </div>
      <canvas id="hc" width="50" height="50"></canvas>
    </div>
  </div>

  <div id="grid-wrap">
    <canvas id="gc" width="300" height="600"></canvas>
    <div id="flash"></div>
    <div id="pips-wrap">
      <div id="pips-label">âš¡</div>
      <div id="pip4" class="pip"></div>
      <div id="pip3" class="pip"></div>
      <div id="pip2" class="pip"></div>
      <div id="pip1" class="pip"></div>
    </div>
    <div id="stars-wrap"></div>
    <div id="badge"></div>
    <div id="overlay">
      <img id="ov-win-img" src="Youwin.png" alt="You Win!">
      <div id="ov-stars"></div>
      <h2 id="ov-title">LEVEL UP!</h2>
      <p id="ov-body"></p>
      <p id="ov-best"></p>
      <button class="ov-btn" id="ov-btn" onclick="handleOverlay()">CONTINUE</button>
      <button id="share-btn" onclick="doShare()">ğŸ“¤ SHARE SCORE</button>
      <button id="power-btn" onclick="usePowerRing()">âš¡ CANDY BOMB</button>
    </div>
  </div>

  <div class="sidebar" id="sb-r">
    <span class="sb-label">NEXT</span>
    <div class="glass-box">
      <canvas id="nc" width="50" height="50"></canvas>
    </div>
  </div>
</div>

<!-- â•â•â• FOOTER â•â•â• -->
<div id="footer">
  <div class="fbt" id="btn-hold" onpointerdown="doHold()">
    <img src="Youwin.png" style="width:36px;height:36px;object-fit:contain;pointer-events:none" alt="Hold">
    <span class="fl">Hold</span>
  </div>
  <div class="fbt" id="btn-drop" onpointerdown="doHardDrop()">
    <span style="font-size:25px">â¬‡</span>
    <span class="fl">Drop</span>
  </div>
  <div class="fbt" id="btn-rotate" onpointerdown="doRotate()">
    <span class="rot-icon">â†º</span>
    <span class="fl">Rotate</span>
  </div>
</div>

<script>
/* ================================================================
   DANTE'S RINGS â€” ENGINE v5.0 "CASCADE GRAVITY"
   A Dante & Coco Adventure
================================================================ */

// â”€â”€ WORLDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WORLDS = [
  { name:"ğŸŒŠ Underwater World", bg1:"#001040", bg2:"#003880", acc:"#00C8FF", ambient:"bubble", speed:860 },
  { name:"ğŸŒŒ Pandora",          bg1:"#1a0040", bg2:"#40008f", acc:"#CC00FF", ambient:"sparkle",speed:790 },
  { name:"â›ï¸ Minecraft",        bg1:"#0a2000", bg2:"#1a5000", acc:"#7CFC00", ambient:"square", speed:720 },
  { name:"ğŸ§± Lego World",       bg1:"#4d0000", bg2:"#990000", acc:"#FF4040", ambient:"dot",    speed:650 },
  { name:"ğŸŒ¿ Rainforest",       bg1:"#001800", bg2:"#003200", acc:"#00FF88", ambient:"leaf",   speed:580 },
  { name:"ğŸš€ Outer Space",      bg1:"#000010", bg2:"#00001c", acc:"#7B2FFF", ambient:"star",   speed:515 },
  { name:"ğŸ¦ Jungle",           bg1:"#0d2000", bg2:"#1f4800", acc:"#AAFF00", ambient:"leaf",   speed:455 },
  { name:"ğŸ« School",           bg1:"#002048", bg2:"#003880", acc:"#FFD600", ambient:"sparkle",speed:395 },
  { name:"â˜€ï¸ Sun Surface",      bg1:"#4d1000", bg2:"#992800", acc:"#FF6200", ambient:"spark",  speed:335 },
  { name:"ğŸ’­ Dream World",      bg1:"#38002e", bg2:"#600050", acc:"#FF2D9B", ambient:"heart",  speed:282 }
];

const LESSONS = [
  "Breathe beneath the surface. Drag to move. Tap to spin. Clear 10 lines to evolve!",
  "Pandora: Curiosity opens every colour inside you.",
  "Minecraft: You can rebuild anything you break, piece by piece.",
  "Lego World: Play is the foundation of everything beautiful.",
  "Rainforest: Trust the growth you cannot see yet.",
  "Outer Space: Stillness lives in the vast unknown.",
  "Jungle: Move with nature â€” instinct is your compass.",
  "School: Every mis-drop is a lesson waiting to be mastered.",
  "Sun Surface: Hold your shape in the heat of transformation.",
  "Dream World: You are home inside your own imagination. ğŸŒŸ"
];

// â”€â”€ COLOURS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLORS = [null,'#FF2D9B','#FFD600','#7B2FFF','#00C8FF','#FF6200','#00FF88','#FF3030','#FFFFFF'];
// index 8 = candy/rainbow special piece
const PIECE_EXPR = [null, 0, 1, 2, 3, 4, 5, 6, 2];

// â”€â”€ CANVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLS=10, ROWS=20, SCALE=30;
const gc   = document.getElementById('gc');
const ctx  = gc.getContext('2d');
const hctx = document.getElementById('hc').getContext('2d');
const nctx = document.getElementById('nc').getContext('2d');
ctx.scale(SCALE, SCALE);
hctx.scale(13, 13);
nctx.scale(13, 13);

// â”€â”€ AUDIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AC = new (window.AudioContext||window.webkitAudioContext)();
const bgMusic = new Audio('Dantesgamemusic.m4a');
bgMusic.loop=true; bgMusic.volume=0.38;
let audioReady=false, muted=false;

function wakeAudio(){
  if(audioReady)return;
  if(AC.state==='suspended')AC.resume();
  audioReady=true;
}
function toggleMute(){
  muted=!muted; bgMusic.muted=muted;
  document.getElementById('mute-btn').textContent=muted?'ğŸ”‡':'ğŸ”Š';
}
function sfx(freq,type='sine',dur=.15,vol=.1){
  if(muted||!audioReady)return;
  const o=AC.createOscillator(),g=AC.createGain();
  o.type=type; o.frequency.setValueAtTime(freq,AC.currentTime);
  g.gain.setValueAtTime(vol,AC.currentTime);
  g.gain.exponentialRampToValueAtTime(.0001,AC.currentTime+dur);
  o.connect(g); g.connect(AC.destination); o.start(); o.stop(AC.currentTime+dur);
}
function sfxClear(n){ [523,659,784,1047].slice(0,Math.min(n,4)).forEach((f,i)=>setTimeout(()=>sfx(f,'sine',.2,.12),i*48)); }
function sfxChain(n){ const f=440+n*120; sfx(f,'square',.35,.14); sfx(f*1.25,'sine',.3,.08); }
function sfxLvlUp(){ [523,659,784,1047,1319].forEach((f,i)=>setTimeout(()=>sfx(f,'square',.18,.11),i*68)); }
function sfxLand(){ sfx(200,'sine',.09,.07); }
function sfxHold(){ sfx(350,'sine',.09,.07); }

// â”€â”€ PIECES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkPiece(t){
  if(t==='I')return[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]];
  if(t==='O')return[[2,2],[2,2]];
  if(t==='T')return[[0,7,0],[7,7,7],[0,0,0]];
  if(t==='S')return[[0,6,6],[6,6,0],[0,0,0]];
  if(t==='Z')return[[5,5,0],[0,5,5],[0,0,0]];
  if(t==='J')return[[3,0,0],[3,3,3],[0,0,0]];
  if(t==='L')return[[0,0,4],[4,4,4],[0,0,0]];
}
const TYPES='IOTSZJL';
let bag=[];
function fromBag(){
  if(!bag.length) bag=[...TYPES].sort(()=>Math.random()-.5);
  return mkPiece(bag.pop());
}
function mkCandy(){ const m=[[0,8,0],[8,8,8],[0,0,0]]; m._candy=true; return m; }

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let arena, player, pieceNext, pieceHeld;
let canHold, totalLines, score, levelIdx, linesThisLevel;
let paused, gameOver;
let dropTimer, lastTs, dropInterval;
let lockTimer=0, lockMoves=0;
const LOCK_DELAY=460, MAX_LOCK_MOVES=12;
let powerCharges=0;
const MAX_POWER=4;
let combo=0;
let particles=[], ambientParts=[];
let shakeAmt=0;
let bestScore=+(localStorage.getItem('dantes_best')||0);
let overlayMode='';

// â”€â”€ CASCADE STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cascading = false;
let cascadeCells = []; // {x, val, fromY, toY, currentY}
let chainCount = 0;
const CASCADE_SPEED = 0.48; // cells per frame (at 60fps ~0.5s for full-height fall)

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initState(){
  arena=Array.from({length:ROWS},()=>Array(COLS).fill(0));
  player={pos:{x:0,y:0},matrix:null};
  pieceNext=fromBag(); pieceHeld=null;
  canHold=true; totalLines=0; score=0; levelIdx=0; linesThisLevel=0;
  paused=false; gameOver=false;
  dropTimer=0; lastTs=0;
  dropInterval=WORLDS[0].speed;
  powerCharges=0; combo=0;
  particles=[]; ambientParts=[];
  lockTimer=0; lockMoves=0;
  shakeAmt=0; bag=[];
  cascading=false; cascadeCells=[]; chainCount=0;
  applyWorldTheme(0,false);
  updateHUD(); updatePips();
  document.getElementById('v-best').textContent=bestScore;
}

// â”€â”€ SPAWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawn(){
  // ~8% chance of candy piece
  if(Math.random()<.08){
    player.matrix=mkCandy();
  } else {
    player.matrix=pieceNext;
    pieceNext=fromBag();
    // occasionally give a candy as next
    if(Math.random()<.08){ pieceNext=mkCandy(); }
  }
  player.pos.y=0;
  player.pos.x=(COLS/2|0)-(player.matrix[0].length/2|0);
  canHold=true; lockTimer=0; lockMoves=0;
  if(collides(arena,player)) triggerGameOver();
}

// â”€â”€ COLLISION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function collides(board,p){
  const m=p.matrix,ox=p.pos.x,oy=p.pos.y;
  for(let y=0;y<m.length;y++){
    for(let x=0;x<m[y].length;x++){
      if(!m[y][x])continue;
      const ny=y+oy,nx=x+ox;
      if(ny<0||ny>=ROWS||nx<0||nx>=COLS)return true;
      if(board[ny][nx])return true;
    }
  }
  return false;
}

// â”€â”€ ROTATION (SRS-lite) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rotateMat(m){ return m[0].map((_,i)=>m.map(r=>r[i]).reverse()); }
function tryRotate(){
  const old=player.matrix;
  player.matrix=rotateMat(player.matrix);
  const kicks=[0,-1,1,-2,2,3,-3];
  for(const k of kicks){
    player.pos.x+=k;
    if(!collides(arena,player)){
      sfx(600,'sine',.055);
      if(lockTimer>0){lockMoves++;lockTimer=0;} // reset lock delay â†’ slide!
      return;
    }
    player.pos.x-=k;
  }
  player.matrix=old;
}

// â”€â”€ MERGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function merge(){
  player.matrix.forEach((row,y)=>row.forEach((v,x)=>{
    if(v) arena[y+player.pos.y][x+player.pos.x]=v;
  }));
}

// â”€â”€ SWEEP â†’ CASCADE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Returns true if cascade was started (caller should NOT spawn immediately)
function sweepIntoCascade(isChain=false){
  // 1. Find full rows
  const fullRows=[];
  for(let y=ROWS-1;y>=0;y--){
    if(arena[y].every(c=>c!==0)) fullRows.push(y);
  }

  // Handle candy bomb: if active piece was candy, nuke tallest column too
  let candyBombCol=-1;
  if(!isChain && player.matrix && player.matrix._candy){
    let maxH=0;
    for(let x=0;x<COLS;x++){
      let h=0; for(let y=0;y<ROWS;y++){if(arena[y][x])h++;} if(h>maxH){maxH=h;candyBombCol=x;}
    }
  }

  if(fullRows.length===0 && candyBombCol<0){
    // Nothing to clear
    combo=0; setDante('idle');
    spawn(); // no cascade needed
    return false;
  }

  // 2. Score & effects
  const cleared=fullRows.length;
  if(cleared>0){
    combo++;
    totalLines+=cleared; linesThisLevel+=cleared;
    const pts=[0,100,300,500,800];
    const chainBonus=isChain? chainCount*50 : 0;
    score += (pts[Math.min(cleared,4)]*(combo>1?combo:1)) + chainBonus;
    powerCharges=Math.min(powerCharges+cleared,MAX_POWER);
    shakeAmt=14+cleared*6;
    sfxClear(cleared);
    flashScreen(WORLDS[levelIdx].acc+'88');
    if(!isChain) showBadge(cleared,false,0);
    setDante('celebrate');
    updateHUD(); updatePips();
  }

  // Particle burst for cleared rows
  fullRows.forEach(y=>{
    for(let x=0;x<COLS;x++){
      const col=COLORS[arena[y][x]]||'#fff';
      for(let i=0;i<8;i++){
        particles.push({x:x+.5,y:y+.5,vx:(Math.random()-.5)*.9,vy:(Math.random()-1.6)*.8,life:1,color:col,size:Math.random()*.26+.08});
      }
    }
  });

  // 3. Clear full rows (zero them out â€” don't splice yet)
  fullRows.forEach(y=>{ for(let x=0;x<COLS;x++) arena[y][x]=0; });

  // 4. Candy bomb: zero the target column
  if(candyBombCol>=0){
    for(let y=0;y<ROWS;y++){
      if(arena[y][candyBombCol]){
        particles.push({x:candyBombCol+.5,y:y+.5,vx:(Math.random()-.5)*1.3,vy:(Math.random()-2)*1,life:1,color:'#FFFFFF',size:.28});
        arena[y][candyBombCol]=0;
      }
    }
    sfx(1300,'square',.28,.13); flashScreen('#FFFFFF');
    shakeAmt=Math.max(shakeAmt,28);
  }

  // 5. Build cascade cells: compact each column, record which cells fall
  cascadeCells=[];
  for(let x=0;x<COLS;x++){
    // Gather non-zero cells topâ†’bottom
    const col=[];
    for(let y=0;y<ROWS;y++){ if(arena[y][x]) col.push({origY:y,val:arena[y][x]}); }
    // Zero the column
    for(let y=0;y<ROWS;y++) arena[y][x]=0;
    // Re-place from bottom, recording movement
    let writeY=ROWS-1;
    for(let i=col.length-1;i>=0;i--){
      const {origY,val}=col[i];
      arena[writeY][x]=val;
      if(origY!==writeY){
        cascadeCells.push({x,val,fromY:origY,toY:writeY,currentY:origY});
      }
      writeY--;
    }
  }

  // 6. Start animation (or skip if nothing to animate)
  if(cascadeCells.length>0){
    cascading=true;
  } else {
    // Already settled â€” check for chains
    afterCascadeSettled();
  }
  return true;
}

// Called each frame while cascading â€” moves cells toward their target
function updateCascade(){
  let allDone=true;
  for(const c of cascadeCells){
    if(c.currentY<c.toY){
      c.currentY=Math.min(c.toY, c.currentY+CASCADE_SPEED);
      if(c.currentY<c.toY) allDone=false;
    }
  }
  if(allDone){
    cascading=false;
    cascadeCells=[];
    afterCascadeSettled();
  }
}

// After all cells have landed â€” check for chain reaction
function afterCascadeSettled(){
  // Check if new full rows formed (chain!)
  let newFull=0;
  for(let y=0;y<ROWS;y++){
    if(arena[y].every(c=>c!==0)) newFull++;
  }
  if(newFull>0){
    chainCount++;
    sfxChain(chainCount);
    flashScreen(WORLDS[levelIdx].acc+'cc');
    showBadge(newFull,true,chainCount);
    setTimeout(()=>sweepIntoCascade(true), 120); // small pause for drama
  } else {
    chainCount=0;
    checkLevelUp();
    if(!gameOver) spawn();
  }
}

// â”€â”€ HARD DROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doHardDrop(){
  if(paused||gameOver||cascading)return;
  let d=0;
  while(!collides(arena,player)){player.pos.y++;d++;}
  player.pos.y--;
  score+=d*2;
  merge();
  const didCascade=sweepIntoCascade();
  if(!didCascade){/* spawn called inside */}
  dropTimer=0; lockTimer=0; lockMoves=0;
  sfx(160,'sine',.1);
}

function lockAndSpawn(){
  merge();
  const didCascade=sweepIntoCascade();
  if(!didCascade){/* spawn called inside */}
  dropTimer=0; lockTimer=0; lockMoves=0;
  sfxLand();
}

// â”€â”€ HOLD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doHold(){
  if(!canHold||paused||gameOver||cascading)return;
  if(!pieceHeld){ pieceHeld=player.matrix; spawn(); }
  else{ [player.matrix,pieceHeld]=[pieceHeld,player.matrix]; player.pos.y=0; player.pos.x=(COLS/2|0)-(player.matrix[0].length/2|0); }
  canHold=false; sfxHold();
}
function doRotate(){ if(!paused&&!gameOver&&!cascading) tryRotate(); }

// â”€â”€ GHOST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ghostY(){
  let gy=player.pos.y;
  while(!collides(arena,{matrix:player.matrix,pos:{x:player.pos.x,y:gy+1}})) gy++;
  return gy;
}

// â”€â”€ POWER RING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function usePowerRing(){
  if(powerCharges<MAX_POWER)return;
  for(let i=0;i<3;i++){arena.pop();arena.unshift(new Array(COLS).fill(0));}
  for(let y=ROWS-3;y<ROWS;y++) for(let x=0;x<COLS;x++) for(let i=0;i<10;i++)
    particles.push({x:x+.5,y:y+.5,vx:(Math.random()-.5)*1.4,vy:(Math.random()-2.2)*1.1,life:1,color:WORLDS[levelIdx].acc,size:.3});
  powerCharges=0; updatePips(); sfx(880,'square',.45,.2); shakeAmt=34; flashScreen('#FF2D9B');
  document.getElementById('power-btn').style.display='none';
}

// â”€â”€ KITTY DRAWING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawKitty(c,px,py,colorIdx,ghost,small){
  if(!COLORS[colorIdx])return;
  const base=COLORS[colorIdx];
  const isCandy=(colorIdx===8);
  const cx=px+.5, cy=py+.5;
  const s=small?.88:1;

  c.globalAlpha=ghost?.27:1;
  c.save(); c.translate(cx,cy); c.scale(s,s); c.translate(-cx,-cy);

  // Ears
  const ec=isCandy?'#FFD600':base;
  c.fillStyle=ec;
  c.beginPath();c.moveTo(cx-.38,cy-.22);c.lineTo(cx-.2,cy-.48);c.lineTo(cx-.08,cy-.22);c.closePath();c.fill();
  c.beginPath();c.moveTo(cx+.08,cy-.22);c.lineTo(cx+.2,cy-.48);c.lineTo(cx+.38,cy-.22);c.closePath();c.fill();
  c.fillStyle='rgba(255,155,200,.75)';
  c.beginPath();c.moveTo(cx-.33,cy-.26);c.lineTo(cx-.21,cy-.42);c.lineTo(cx-.12,cy-.26);c.closePath();c.fill();
  c.beginPath();c.moveTo(cx+.12,cy-.26);c.lineTo(cx+.21,cy-.42);c.lineTo(cx+.33,cy-.26);c.closePath();c.fill();

  // Head
  c.beginPath();c.arc(cx,cy+.02,.42,0,Math.PI*2);
  if(!ghost){
    if(isCandy){
      const rg=c.createLinearGradient(cx-.42,cy-.42,cx+.42,cy+.42);
      rg.addColorStop(0,'#FF2D9B');rg.addColorStop(.25,'#FFD600');rg.addColorStop(.5,'#00FF88');rg.addColorStop(.75,'#00C8FF');rg.addColorStop(1,'#7B2FFF');
      c.fillStyle=rg;
    } else {
      const gr=c.createRadialGradient(cx-.1,cy-.12,.04,cx,cy,.45);
      gr.addColorStop(0,'rgba(255,255,255,.94)');
      gr.addColorStop(.22,base); gr.addColorStop(.8,base);
      gr.addColorStop(1,'rgba(0,0,0,.44)');
      c.fillStyle=gr;
    }
  } else { c.fillStyle=base; }
  c.fill();
  c.strokeStyle='rgba(255,255,255,.72)'; c.lineWidth=.06; c.stroke();

  if(!ghost){
    const expr=PIECE_EXPR[colorIdx]||0;

    // Eyes
    if(expr===0){// happy
      c.fillStyle='#111'; c.beginPath();c.arc(cx-.13,cy-.03,.07,0,Math.PI*2);c.fill();
      c.beginPath();c.arc(cx+.13,cy-.03,.07,0,Math.PI*2);c.fill();
      c.fillStyle='white'; c.beginPath();c.arc(cx-.1,cy-.06,.03,0,Math.PI*2);c.fill();
      c.beginPath();c.arc(cx+.16,cy-.06,.03,0,Math.PI*2);c.fill();
    } else if(expr===1){// wink
      c.fillStyle='#111'; c.beginPath();c.arc(cx+.13,cy-.03,.07,0,Math.PI*2);c.fill();
      c.fillStyle='white'; c.beginPath();c.arc(cx+.16,cy-.06,.03,0,Math.PI*2);c.fill();
      c.strokeStyle='#111'; c.lineWidth=.055;
      c.beginPath();c.moveTo(cx-.18,cy-.04);c.lineTo(cx-.08,cy-.04);c.stroke();
    } else if(expr===2){// star eyes
      drawStar(c,cx-.13,cy-.03,.08,'#FFD600');
      drawStar(c,cx+.13,cy-.03,.08,'#FFD600');
    } else if(expr===3){// surprised
      c.fillStyle='#111'; c.beginPath();c.arc(cx-.13,cy-.03,.08,0,Math.PI*2);c.fill();
      c.beginPath();c.arc(cx+.13,cy-.03,.08,0,Math.PI*2);c.fill();
      c.fillStyle='white'; c.beginPath();c.arc(cx-.1,cy-.06,.04,0,Math.PI*2);c.fill();
      c.beginPath();c.arc(cx+.16,cy-.06,.04,0,Math.PI*2);c.fill();
    } else if(expr===4){// hearts
      drawHeart(c,cx-.13,cy-.03,.08,'#FF2D9B');
      drawHeart(c,cx+.13,cy-.03,.08,'#FF2D9B');
    } else if(expr===5){// sleepy
      c.strokeStyle='#111'; c.lineWidth=.055;
      c.beginPath();c.moveTo(cx-.19,cy-.04);c.lineTo(cx-.08,cy-.04);c.stroke();
      c.beginPath();c.moveTo(cx+.08,cy-.04);c.lineTo(cx+.19,cy-.04);c.stroke();
    } else if(expr===6){// cool shades
      c.fillStyle='#111';
      c.beginPath();if(c.roundRect)c.roundRect(cx-.22,cy-.08,.16,.11,.03);else c.rect(cx-.22,cy-.08,.16,.11);c.fill();
      c.beginPath();if(c.roundRect)c.roundRect(cx+.06,cy-.08,.16,.11,.03);else c.rect(cx+.06,cy-.08,.16,.11);c.fill();
      c.strokeStyle='#333'; c.lineWidth=.04;
      c.beginPath();c.moveTo(cx-.06,cy-.03);c.lineTo(cx+.06,cy-.03);c.stroke();
    }

    // Nose
    c.fillStyle='#FF69B4'; c.beginPath();c.arc(cx,cy+.07,.04,0,Math.PI*2);c.fill();

    // Whiskers
    c.strokeStyle='rgba(80,80,80,.48)'; c.lineWidth=.024;
    c.beginPath();c.moveTo(cx-.43,cy+.04);c.lineTo(cx-.12,cy+.08);c.stroke();
    c.beginPath();c.moveTo(cx-.43,cy+.13);c.lineTo(cx-.12,cy+.13);c.stroke();
    c.beginPath();c.moveTo(cx+.12,cy+.08);c.lineTo(cx+.43,cy+.04);c.stroke();
    c.beginPath();c.moveTo(cx+.12,cy+.13);c.lineTo(cx+.43,cy+.13);c.stroke();

    // Mouth
    c.strokeStyle='rgba(60,60,60,.68)'; c.lineWidth=.03;
    if(expr===3){ c.beginPath();c.arc(cx,cy+.18,.07,0,Math.PI*2);c.stroke(); }
    else if(expr===5){ c.beginPath();c.moveTo(cx-.07,cy+.18);c.lineTo(cx+.07,cy+.18);c.stroke(); }
    else { c.beginPath();c.arc(cx,cy+.16,.09,.1,Math.PI-.1);c.stroke(); }

    // Bow
    const bx=cx+.22, by=cy-.35;
    const bc=isCandy?'#FFFFFF':lighten(base);
    c.fillStyle=bc;
    c.beginPath();c.moveTo(bx,by);c.lineTo(bx-.14,by-.09);c.lineTo(bx-.14,by+.09);c.closePath();c.fill();
    c.beginPath();c.moveTo(bx,by);c.lineTo(bx+.14,by-.09);c.lineTo(bx+.14,by+.09);c.closePath();c.fill();
    c.fillStyle='rgba(255,255,255,.82)'; c.beginPath();c.arc(bx,by,.035,0,Math.PI*2);c.fill();

    // Specular
    c.beginPath();c.arc(cx-.13,cy-.14,.09,0,Math.PI*2);
    c.fillStyle='rgba(255,255,255,.42)'; c.fill();
  }
  c.restore(); c.globalAlpha=1;
}

function drawStar(c,cx,cy,r,col){
  c.fillStyle=col; c.beginPath();
  for(let i=0;i<5;i++){
    const a=Math.PI*2*i/5-Math.PI/2, b=Math.PI*2*(i+.5)/5-Math.PI/2;
    i===0?c.moveTo(cx+Math.cos(a)*r,cy+Math.sin(a)*r):c.lineTo(cx+Math.cos(a)*r,cy+Math.sin(a)*r);
    c.lineTo(cx+Math.cos(b)*r*.42,cy+Math.sin(b)*r*.42);
  }
  c.closePath(); c.fill();
}
function drawHeart(c,cx,cy,r,col){
  c.fillStyle=col; c.beginPath();
  c.moveTo(cx,cy+r*.6);
  c.bezierCurveTo(cx-r*1.1,cy-r*.2,cx-r*1.1,cy-r*.9,cx,cy-r*.3);
  c.bezierCurveTo(cx+r*1.1,cy-r*.9,cx+r*1.1,cy-r*.2,cx,cy+r*.6);
  c.fill();
}
function lighten(hex){
  const n=parseInt(hex.slice(1),16);
  return '#'+[((n>>16)&0xFF),(( n>>8)&0xFF),(n&0xFF)].map(v=>Math.min(255,v+85).toString(16).padStart(2,'0')).join('');
}

function drawMatrix(c,m,pos,ghost=false,small=false){
  if(!m)return;
  m.forEach((row,y)=>row.forEach((v,x)=>{ if(v) drawKitty(c,x+pos.x,y+pos.y,v,ghost,small); }));
}

// â”€â”€ BACKGROUND & AMBIENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ambTimer=0;
function spawnAmbient(){
  const w=WORLDS[levelIdx], t=w.ambient;
  if(t==='bubble') ambientParts.push({type:'bubble',x:Math.random()*COLS,y:ROWS+.5,vx:(Math.random()-.5)*.05,vy:-(Math.random()*.04+.02),life:1,r:Math.random()*.11+.04,decay:.005});
  else if(t==='star'||t==='sparkle') ambientParts.push({type:'star',x:Math.random()*COLS,y:Math.random()*ROWS,life:1,r:Math.random()*.07+.03,col:w.acc,decay:.007+Math.random()*.008});
  else if(t==='heart') ambientParts.push({type:'heart',x:Math.random()*COLS,y:ROWS+.5,vy:-(Math.random()*.03+.014),life:1,r:.11+Math.random()*.07,col:'#FF2D9B',decay:.005});
  else ambientParts.push({type:'dot',x:Math.random()*COLS,y:ROWS+.5,vy:-(Math.random()*.05+.02),vx:(Math.random()-.5)*.04,life:1,r:.06+Math.random()*.05,col:w.acc,decay:.006});
  if(ambientParts.length>45)ambientParts.shift();
}

function drawBg(){
  const w=WORLDS[levelIdx];
  const gr=ctx.createLinearGradient(0,0,0,ROWS);
  gr.addColorStop(0,w.bg1); gr.addColorStop(1,w.bg2);
  ctx.fillStyle=gr; ctx.fillRect(0,0,COLS,ROWS);
  ctx.strokeStyle='rgba(255,255,255,.07)'; ctx.lineWidth=.03;
  for(let x=0;x<=COLS;x++){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,ROWS);ctx.stroke();}
  for(let y=0;y<=ROWS;y++){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(COLS,y);ctx.stroke();}

  ambTimer++;
  if(ambTimer%7===0) spawnAmbient();

  for(let i=ambientParts.length-1;i>=0;i--){
    const p=ambientParts[i];
    p.life-=p.decay||.006;
    if(p.life<=0){ambientParts.splice(i,1);continue;}
    ctx.globalAlpha=p.life*.45;
    if(p.type==='bubble'){
      p.x+=p.vx; p.y+=p.vy;
      ctx.strokeStyle='rgba(150,220,255,.7)'; ctx.lineWidth=.04;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.stroke();
    } else if(p.type==='star'){
      ctx.fillStyle=p.col;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r*(Math.sin(Date.now()*.005+p.x)+.5+.5),0,Math.PI*2); ctx.fill();
    } else if(p.type==='heart'){
      p.y+=p.vy; ctx.fillStyle=p.col;
      ctx.beginPath(); ctx.moveTo(p.x,p.y+p.r*.6);
      ctx.bezierCurveTo(p.x-p.r,p.y-p.r*.3,p.x-p.r,p.y-p.r*.8,p.x,p.y-p.r*.2);
      ctx.bezierCurveTo(p.x+p.r,p.y-p.r*.8,p.x+p.r,p.y-p.r*.3,p.x,p.y+p.r*.6); ctx.fill();
    } else {
      p.x+=p.vx||0; p.y+=p.vy;
      ctx.fillStyle=p.col; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha=1;
  }
}

// â”€â”€ PARTICLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tickParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx; p.y+=p.vy; p.vy+=.033; p.life-=.026;
    if(p.life<=0) particles.splice(i,1);
  }
}
function drawParticles(){
  particles.forEach(p=>{
    ctx.globalAlpha=p.life; ctx.fillStyle=p.color;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
  });
  ctx.globalAlpha=1;
}

// â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSidebar(c,m){
  c.clearRect(0,0,5,5);
  if(!m)return;
  const ox=Math.floor((4-m[0].length)/2), oy=Math.floor((4-m.length)/2);
  drawMatrix(c,m,{x:ox,y:oy},false,true);
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(){
  let ox=0,oy=0;
  if(shakeAmt>0){
    ox=(Math.random()-.5)*shakeAmt*.17; oy=(Math.random()-.5)*shakeAmt*.17;
    shakeAmt*=.79; if(shakeAmt<.35) shakeAmt=0;
  }
  ctx.save(); ctx.translate(ox,oy);
  drawBg();

  if(cascading){
    // Build skip set: cells at their toY are being animated, don't draw them from arena
    const skip=new Set(cascadeCells.map(c=>`${c.x},${c.toY}`));

    // Draw static arena minus cascade cells
    for(let y=0;y<ROWS;y++){
      for(let x=0;x<COLS;x++){
        const v=arena[y][x];
        if(v && !skip.has(`${x},${y}`)) drawKitty(ctx,x,y,v,false,false);
      }
    }

    // Draw cascade cells at their animated position with a subtle trail
    cascadeCells.forEach(c=>{
      // Trail streak
      ctx.globalAlpha=.18;
      ctx.fillStyle=COLORS[c.val]||'#fff';
      ctx.fillRect(c.x+.2, c.currentY-.35, .6, .38);
      ctx.globalAlpha=1;
      // The kitty face at its current (animated) Y
      drawKitty(ctx, c.x, c.currentY, c.val, false, false);
    });
  } else {
    drawMatrix(ctx, arena, {x:0,y:0});
    if(player.matrix){
      drawMatrix(ctx, player.matrix, {x:player.pos.x,y:ghostY()}, true);
      drawMatrix(ctx, player.matrix, player.pos);
    }
  }

  tickParticles(); drawParticles();
  ctx.restore();

  drawSidebar(nctx, pieceNext);
  drawSidebar(hctx, pieceHeld);
}

// â”€â”€ MAIN LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tick(ts=0){
  if(paused||gameOver)return;
  const dt=Math.min(ts-lastTs,100); lastTs=ts;

  if(cascading){
    updateCascade();
    render();
    requestAnimationFrame(tick);
    return; // gravity suspended during cascade
  }

  dropTimer+=dt;
  if(dropTimer>dropInterval){
    player.pos.y++;
    if(collides(arena,player)){
      player.pos.y--;
      lockTimer+=dropInterval;
      if(lockTimer>=LOCK_DELAY||lockMoves>=MAX_LOCK_MOVES){
        lockAndSpawn();
      }
    } else {
      lockTimer=0; lockMoves=0;
    }
    dropTimer=0;
  }
  render();
  requestAnimationFrame(tick);
}

// â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHUD(){
  document.getElementById('v-score').textContent=score;
  document.getElementById('v-lines').textContent=totalLines;
  document.getElementById('v-best').textContent=bestScore;
  const w=WORLDS[levelIdx];
  document.getElementById('world-name').textContent=w.name;
  document.getElementById('world-name').style.color=w.acc;
  document.getElementById('world-name').style.textShadow=`0 0 16px ${w.acc}`;
  const pct=Math.min(100,(linesThisLevel/10)*100);
  document.getElementById('prog-bar').style.width=pct+'%';
  document.getElementById('prog-bar').style.background=`linear-gradient(90deg,${w.acc},rgba(255,255,255,.25))`;
  const stars=linesThisLevel>=10?'â­â­â­':linesThisLevel>=7?'â­â­':linesThisLevel>=4?'â­':'';
  document.getElementById('stars-wrap').textContent=stars;
}

function checkLevelUp(){
  if(linesThisLevel>=10){
    linesThisLevel=0;
    if(levelIdx>=WORLDS.length-1){ showOverlay('ğŸŒŸ DREAM WORLD!',LESSONS[levelIdx],true); return; }
    levelIdx++;
    dropInterval=WORLDS[levelIdx].speed;
    sfxLvlUp();
    applyWorldTheme(levelIdx,true);
    showOverlay(WORLDS[levelIdx].name,LESSONS[levelIdx],false);
    updateHUD();
  }
}

// â”€â”€ WORLD THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyWorldTheme(idx,anim){
  const w=WORLDS[idx];
  document.body.style.background=w.bg1;
  document.documentElement.style.setProperty('--acc',w.acc);
  ambientParts=[];
  if(!anim)return;
  const wf=document.getElementById('wflash');
  wf.textContent=w.name;
  wf.style.cssText=`background:${w.bg1};color:${w.acc};text-shadow:0 0 28px ${w.acc};display:flex;animation:none`;
  wf.offsetHeight;
  wf.style.animation='wfAnim 1.7s ease forwards';
  setTimeout(()=>{wf.style.display='none';},1750);
}

// â”€â”€ OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showOverlay(title,body,win){
  paused=true; bgMusic.pause();
  document.getElementById('ov-title').textContent=title;
  document.getElementById('ov-body').textContent=body;
  document.getElementById('ov-win-img').style.display=win?'block':'none';
  const isGO=(title==='ğŸ’€ STACKED OUT!');
  if(score>bestScore){bestScore=score;localStorage.setItem('dantes_best',bestScore);}
  document.getElementById('ov-best').textContent=`BEST: ${bestScore}`;
  const st=linesThisLevel>=9?'â­â­â­':linesThisLevel>=6?'â­â­':linesThisLevel>=3?'â­':'';
  document.getElementById('ov-stars').textContent=win?'â­â­â­':st;
  if(win){overlayMode='win';document.getElementById('ov-btn').textContent='ğŸ‰ PLAY AGAIN';document.getElementById('share-btn').style.display='block';setDante('win');}
  else if(isGO){overlayMode='restart';document.getElementById('ov-btn').textContent='ğŸ”„ TRY AGAIN';document.getElementById('share-btn').style.display='block';document.getElementById('power-btn').style.display=powerCharges>=MAX_POWER?'block':'none';setDante('sad');}
  else{overlayMode='continue';document.getElementById('ov-btn').textContent='â–¶ CONTINUE';document.getElementById('share-btn').style.display='none';document.getElementById('power-btn').style.display='none';}
  document.getElementById('overlay').style.display='flex';
}

function handleOverlay(){
  document.getElementById('overlay').style.display='none';
  document.getElementById('share-btn').style.display='none';
  document.getElementById('power-btn').style.display='none';
  if(overlayMode==='continue'){paused=false;if(!muted)bgMusic.play();requestAnimationFrame(tick);}
  else{bag=[];initState();spawn();if(!muted)bgMusic.play().catch(()=>{});requestAnimationFrame(tick);}
}

function triggerGameOver(){
  gameOver=true; sfx(120,'sawtooth',.9,.12);
  showOverlay('ğŸ’€ STACKED OUT!',"Breathe. Every pattern teaches you something.",false);
}
function doPause(){
  if(gameOver||cascading)return;
  if(!paused){showOverlay('â¸ PAUSED','Take a breath. Come back when ready.',false);overlayMode='continue';}
}

// â”€â”€ SHARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doShare(){
  const t=`ğŸŒŸ I scored ${score} pts and reached ${WORLDS[levelIdx].name} in Dante's Rings! Can you beat me? ğŸ® #DantesRings`;
  if(navigator.share)navigator.share({title:"Dante's Rings",text:t,url:location.href});
  else navigator.clipboard?.writeText(t).then(()=>alert('Score copied! Share it ğŸ‰'));
}

// â”€â”€ DANTE EXPRESSIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MOODS={idle:'ğŸ˜Š',nervous:'ğŸ˜°',celebrate:'ğŸ‰',sad:'ğŸ˜¢',win:'ğŸŒŸ'};
let moodTO=null;
function setDante(mood){
  document.getElementById('dante-mood').textContent=MOODS[mood]||'ğŸ˜Š';
  const w=document.getElementById('dante-wrap');
  if(mood==='celebrate'){w.style.transform='translateX(-50%) scale(1.55) translateY(-16px)';setTimeout(()=>{w.style.transform='translateX(-50%)';},460);}
  else if(mood==='win'){w.style.transform='translateX(-50%) rotate(11deg) scale(1.38)';}
  else if(mood==='sad'){w.style.transform='translateX(-50%) scale(.85) translateY(5px)';}
  else{w.style.transform='translateX(-50%)';}
  clearTimeout(moodTO);
  if(mood==='idle'||mood==='celebrate') moodTO=setTimeout(checkDanger,950);
}
function checkDanger(){
  let f=0;
  for(let y=0;y<ROWS/2;y++) for(let x=0;x<COLS;x++) if(arena[y][x])f++;
  if(f>(ROWS/2)*COLS*.28) document.getElementById('dante-mood').textContent=MOODS.nervous;
}

// â”€â”€ PIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePips(){ for(let i=1;i<=MAX_POWER;i++) document.getElementById('pip'+i).classList.toggle('on',i<=powerCharges); }

// â”€â”€ FLASH & BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function flashScreen(col='rgba(255,255,255,.42)'){
  const f=document.getElementById('flash');
  f.style.background=col; f.style.opacity='1'; setTimeout(()=>{f.style.opacity='0';},90);
}
const CMSG=['','NICE!','GREAT!','AMAZING!','TETRIS!'];
const CCOL=['','#00FF88','#FFD600','#FF6200','#FF2D9B'];
const CHAIN_MSG=['','â›“ CHAIN!','â›“â›“ DOUBLE!','ğŸ’¥ MEGA CHAIN!','ğŸŒŸ ULTRA CHAIN!'];

function showBadge(cleared,isChain,chainNum){
  const b=document.getElementById('badge');
  let msg,col;
  if(isChain){
    msg=CHAIN_MSG[Math.min(chainNum,4)]||`âš¡ CHAIN x${chainNum}!`;
    col='#FF2D9B';
  } else if(combo>1){
    msg=`COMBO x${combo}! ğŸ”¥`; col='#FF2D9B';
  } else {
    msg=CMSG[Math.min(cleared,4)]||''; col=CCOL[Math.min(cleared,4)];
  }
  if(!msg)return;
  b.textContent=msg; b.style.color=col;
  b.style.animation='none'; b.offsetHeight;
  b.style.animation='badgePop 1.1s ease forwards';
}

// â”€â”€ TOUCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tx0,ty0,tmoved,softDrop=false;
const gw=document.getElementById('grid-wrap');
gw.addEventListener('touchstart',e=>{
  if(paused||gameOver)return;
  tx0=e.touches[0].clientX; ty0=e.touches[0].clientY; tmoved=false;
},{passive:false});
gw.addEventListener('touchmove',e=>{
  if(paused||gameOver||cascading)return; e.preventDefault();
  const dx=e.touches[0].clientX-tx0, dy=e.touches[0].clientY-ty0;
  if(Math.abs(dx)>8||Math.abs(dy)>8) tmoved=true;
  if(Math.abs(dx)>27){
    const dir=dx>0?1:-1;
    player.pos.x+=dir;
    if(collides(arena,player)){player.pos.x-=dir;}
    else{sfx(400,'sine',.04);if(lockTimer>0){lockMoves++;lockTimer=0;}}
    tx0=e.touches[0].clientX;
  }
  if(dy>48&&!softDrop){dropInterval=38;softDrop=true;}
},{passive:false});
gw.addEventListener('touchend',()=>{
  if(paused||gameOver)return;
  if(!tmoved&&!cascading) tryRotate();
  if(softDrop){dropInterval=WORLDS[levelIdx].speed;softDrop=false;}
});

// â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown',e=>{
  if(paused||gameOver)return;
  if(cascading&&e.key!==' '&&e.key!=='p'&&e.key!=='P')return; // block most input during cascade
  if(e.key==='ArrowLeft'){player.pos.x--;if(collides(arena,player))player.pos.x++;else{sfx(380,'sine',.04);if(lockTimer>0){lockMoves++;lockTimer=0;}}}
  if(e.key==='ArrowRight'){player.pos.x++;if(collides(arena,player))player.pos.x--;else{sfx(380,'sine',.04);if(lockTimer>0){lockMoves++;lockTimer=0;}}}
  if(e.key==='ArrowDown') dropInterval=50;
  if(e.key==='ArrowUp'||e.key==='x'||e.key==='X') tryRotate();
  if(e.key===' '){e.preventDefault();doHardDrop();}
  if(e.key==='h'||e.key==='H'||e.key==='Shift') doHold();
  if(e.key==='p'||e.key==='P') doPause();
  if(e.key==='q'&&powerCharges>=MAX_POWER) usePowerRing();
});
document.addEventListener('keyup',e=>{if(e.key==='ArrowDown')dropInterval=WORLDS[levelIdx].speed;});

// â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGame(){
  wakeAudio();
  document.getElementById('start').style.display='none';
  initState(); spawn();
  if(!muted)bgMusic.play().catch(()=>{});
  requestAnimationFrame(tick);
}

// Show best on start screen
(function(){
  const b=localStorage.getItem('dantes_best');
  if(b&&+b>0)document.getElementById('start-best').textContent=`ğŸ† BEST SCORE: ${b}`;
})();

// Pre-render static frame
(function(){
  const w=WORLDS[0];
  const gr=ctx.createLinearGradient(0,0,0,ROWS); gr.addColorStop(0,w.bg1); gr.addColorStop(1,w.bg2);
  ctx.fillStyle=gr; ctx.fillRect(0,0,COLS,ROWS);
  ctx.strokeStyle='rgba(255,255,255,.07)'; ctx.lineWidth=.03;
  for(let x=0;x<=COLS;x++){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,ROWS);ctx.stroke();}
  for(let y=0;y<=ROWS;y++){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(COLS,y);ctx.stroke();}
})();
</script>
</body>
</html>
