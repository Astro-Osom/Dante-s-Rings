<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dante's Rings: A Future Vibrant Self Adventure</title>
    <link rel="apple-touch-icon" href="Dante_App_Logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="Dante_App_Logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="Dante_App_Logo.png">
    <link rel="apple-touch-icon" sizes="167x167" href="Dante_App_Logo.png">
    <meta name="apple-mobile-web-app-title" content="Dante's Rings">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <style>
        /* ============================================================
           DANTE'S RINGS ‚Äî VIBRANT REBUILD v2.0
           Future Vibrant Self Adventure
        ============================================================ */
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --neon-blue:   #00C8FF;
            --neon-green:  #00FF88;
            --neon-pink:   #FF2D9B;
            --neon-gold:   #FFD600;
            --glass-dark:  rgba(0, 0, 0, 0.72);
            --glass-mid:   rgba(0, 0, 0, 0.50);
            --glass-border:rgba(255,255,255,0.30);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0; overflow: hidden;
            background: #060618 url('Roblox_Bg.jpg') no-repeat center center / cover fixed;
            color: #fff;
            font-family: 'Avenir Next', 'Helvetica Neue', Arial, sans-serif;
            touch-action: none;
            user-select: none; -webkit-user-select: none;
            display: flex; flex-direction: column;
            height: 100dvh; width: 100vw;
        }

        /* ‚îÄ‚îÄ CLOUDS ‚îÄ‚îÄ */
        .cloud {
            position: fixed; pointer-events: none; z-index: 0;
            background: rgba(255,255,255,0.18);
            border-radius: 50px;
            filter: blur(3px);
        }
        @keyframes drift { from { transform: translateX(-300px); } to { transform: translateX(110vw); } }

        /* ‚îÄ‚îÄ HEADER HUD ‚îÄ‚îÄ */
        #hud {
            padding-top: calc(var(--safe-top) + 8px);
            padding-bottom: 10px;
            width: 100%;
            display: flex; flex-direction: column;
            align-items: center; gap: 5px;
            background: var(--glass-dark);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 2px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0,0,0,0.6);
            z-index: 500; flex-shrink: 0;
        }
        #world-name {
            font-size: clamp(16px, 5vw, 26px);
            font-weight: 900; text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--neon-blue);
            text-shadow: 0 0 20px var(--neon-blue), 0 0 40px rgba(0,200,255,0.4);
            margin: 0;
        }
        #hud-stats {
            display: flex; gap: 24px;
            font-size: clamp(12px, 3.5vw, 17px);
            font-weight: 800; letter-spacing: 1px;
            color: rgba(255,255,255,0.9);
        }
        #hud-stats span b { color: var(--neon-gold); text-shadow: 0 0 10px var(--neon-gold); }
        #progress-wrap {
            width: 78%; height: 10px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.25);
            border-radius: 20px; overflow: hidden;
        }
        #progress-bar {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, var(--neon-green), var(--neon-blue));
            box-shadow: 0 0 12px var(--neon-green);
            border-radius: 20px;
            transition: width 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* ‚îÄ‚îÄ GAME VIEWPORT ‚îÄ‚îÄ */
        #viewport {
            flex: 1; min-height: 0;
            display: flex;
            align-items: center; justify-content: center;
            position: relative; z-index: 10;
            padding: 10px 8px;
        }

        /* Sidebars float absolutely so grid stays centred */
        .sidebar {
            position: absolute;
            display: flex; flex-direction: column;
            align-items: center; gap: 8px;
            width: 72px; z-index: 20;
        }
        #sidebar-l { left: 8px; }
        #sidebar-r { right: 8px; }

        .sidebar-label {
            font-size: 9px; font-weight: 900;
            letter-spacing: 2px; text-transform: uppercase;
            color: rgba(255,255,255,0.45);
        }
        .glass-box {
            width: 68px; height: 68px;
            background: var(--glass-dark);
            border: 3px solid rgba(255,255,255,0.5);
            border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            position: relative;
            box-shadow: 0 8px 30px rgba(0,0,0,0.7),
                        inset 0 1px 0 rgba(255,255,255,0.15);
        }

        /* Dante avatar pinned above hold box */
        #dante-wrap {
            position: absolute;
            top: -72px; left: 50%; transform: translateX(-50%);
            width: 64px; height: 64px;
            transition: transform 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 30;
        }
        #dante-img {
            width: 100%; height: 100%; object-fit: contain;
            filter: drop-shadow(0 6px 12px rgba(0,0,0,0.7));
        }
        /* Dante expression emoji badge */
        #dante-mood {
            position: absolute; bottom: -4px; right: -4px;
            font-size: 20px; line-height: 1;
            transition: opacity 0.3s;
        }

        /* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
        #grid-wrap {
            position: relative;
            height: 100%;
            aspect-ratio: 10 / 20;
            border: 5px solid rgba(255,255,255,0.75);
            border-radius: 28px;
            overflow: hidden;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.1),
                        0 25px 80px rgba(0,0,0,0.85),
                        inset 0 0 60px rgba(0,0,0,0.3);
        }
        #game-canvas {
            width: 100%; height: 100%;
            display: block;
            image-rendering: auto;
        }

        /* Line-clear flash overlay */
        #flash-overlay {
            position: absolute; inset: 0;
            pointer-events: none; z-index: 15;
            opacity: 0; border-radius: 24px;
            background: rgba(255,255,255,0.45);
            transition: opacity 0.05s;
        }

        /* ‚îÄ‚îÄ IN-GAME OVERLAY (narrative / game-over / win) ‚îÄ‚îÄ */
        #overlay {
            position: absolute; inset: 0;
            display: none;
            flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 30px;
            background: rgba(0,0,0,0.92);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-radius: 24px; z-index: 100;
        }
        #ov-win-img {
            width: min(240px, 80%); border-radius: 30px;
            border: 6px solid white; margin-bottom: 20px;
            display: none;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }
        #ov-title {
            font-size: clamp(26px, 8vw, 48px);
            font-weight: 900; text-transform: uppercase;
            color: var(--neon-blue); margin: 0 0 12px;
            text-shadow: 0 0 20px var(--neon-blue);
            letter-spacing: 2px;
        }
        #ov-body {
            font-size: clamp(13px, 3.5vw, 19px);
            line-height: 1.55; color: rgba(255,255,255,0.85);
            max-width: 300px; margin: 0 0 24px;
        }
        .ov-btn {
            padding: 16px 48px;
            background: linear-gradient(135deg, var(--neon-green), #00c864);
            color: #000; font-weight: 900;
            font-size: clamp(18px, 5vw, 26px);
            text-transform: uppercase; letter-spacing: 2px;
            border: 4px solid white; border-radius: 60px;
            cursor: pointer;
            box-shadow: 0 8px 0 #006b35, 0 12px 30px rgba(0,255,136,0.3);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .ov-btn:active { transform: translateY(5px); box-shadow: 0 3px 0 #006b35; }

        /* Power Ring button */
        #power-btn {
            display: none;
            margin-top: 14px;
            padding: 12px 36px;
            background: linear-gradient(135deg, var(--neon-pink), #c0006e);
            color: white; font-weight: 900;
            font-size: clamp(13px, 3.5vw, 18px);
            text-transform: uppercase; letter-spacing: 1px;
            border: 3px solid white; border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #7a004a;
        }

        /* ‚îÄ‚îÄ START SCREEN ‚îÄ‚îÄ */
        #start-screen {
            position: fixed; inset: 0; z-index: 9000;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: linear-gradient(160deg, #0a0a2e 0%, #001c3d 50%, #0a0a2e 100%);
            text-align: center; padding: 30px;
        }
        .start-card {
            background: var(--glass-dark);
            border: 4px solid var(--glass-border);
            border-radius: 50px; padding: 40px 35px;
            max-width: 380px; width: 100%;
            backdrop-filter: blur(20px);
            box-shadow: 0 30px 80px rgba(0,0,0,0.9);
        }
        #start-logo {
            width: min(160px, 55%); margin-bottom: 20px;
            filter: drop-shadow(0 10px 30px rgba(0,200,255,0.5));
            animation: floatLogo 3s ease-in-out infinite;
        }
        @keyframes floatLogo {
            0%,100% { transform: translateY(0); }
            50%      { transform: translateY(-12px); }
        }
        #start-title {
            font-size: clamp(32px, 10vw, 52px);
            font-weight: 900; letter-spacing: 4px;
            color: white; margin: 0;
            text-shadow: 0 0 30px rgba(0,200,255,0.7);
        }
        #start-sub {
            font-size: clamp(12px, 3.5vw, 16px);
            color: var(--neon-blue); margin: 8px 0 30px;
            letter-spacing: 1px;
        }
        #start-btn {
            padding: 20px 60px;
            background: linear-gradient(135deg, var(--neon-blue), #0064a1);
            color: white; font-weight: 900;
            font-size: clamp(20px, 5.5vw, 30px);
            text-transform: uppercase; letter-spacing: 3px;
            border: 5px solid white; border-radius: 70px;
            cursor: pointer;
            box-shadow: 0 10px 0 #003d6b, 0 15px 40px rgba(0,200,255,0.35);
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%,100% { box-shadow: 0 10px 0 #003d6b, 0 15px 40px rgba(0,200,255,0.35); }
            50%      { box-shadow: 0 10px 0 #003d6b, 0 15px 60px rgba(0,200,255,0.7); }
        }
        #start-btn:active { transform: translateY(6px); box-shadow: 0 4px 0 #003d6b; animation: none; }

        /* Hint bubbles on start screen */
        .hint-row {
            display: flex; gap: 12px; margin-top: 24px;
            justify-content: center; flex-wrap: wrap;
        }
        .hint-chip {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 40px; padding: 8px 16px;
            font-size: 12px; font-weight: 700;
            color: rgba(255,255,255,0.7);
            letter-spacing: 0.5px;
        }

        /* ‚îÄ‚îÄ FOOTER CONTROLS ‚îÄ‚îÄ */
        #footer {
            padding-bottom: calc(var(--safe-bottom) + 6px);
            padding-top: 6px;
            width: 100%;
            display: flex; justify-content: center;
            align-items: center; gap: 28px;
            background: var(--glass-dark);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 2px solid var(--glass-border);
            flex-shrink: 0; z-index: 500;
        }
        .foot-btn {
            width: clamp(90px, 26vw, 130px);
            height: clamp(64px, 14vh, 90px);
            border-radius: 30px;
            border: 5px solid rgba(255,255,255,0.85);
            cursor: pointer; display: flex;
            flex-direction: column;
            align-items: center; justify-content: center; gap: 2px;
            box-shadow: 0 8px 0 rgba(0,0,0,0.5);
            transition: transform 0.1s, box-shadow 0.1s;
            font-size: 32px;
            font-weight: 900; color: white;
        }
        .foot-btn:active { transform: translateY(5px); box-shadow: 0 3px 0 rgba(0,0,0,0.5); }
        .foot-btn span.label {
            font-size: 9px; font-weight: 900;
            letter-spacing: 1.5px; text-transform: uppercase;
            opacity: 0.8;
        }
        #btn-hold {
            background: linear-gradient(160deg, #7B2FFF, #4a00b8);
            box-shadow: 0 8px 0 #2a007a, 0 0 20px rgba(123,47,255,0.4);
        }
        #btn-rotate {
            background: linear-gradient(160deg, var(--neon-pink), #b8004a);
            box-shadow: 0 8px 0 #7a0030, 0 0 20px rgba(255,45,155,0.4);
        }
        #btn-drop {
            background: linear-gradient(160deg, var(--neon-gold), #b88a00);
            box-shadow: 0 8px 0 #7a5900, 0 0 20px rgba(255,214,0,0.4);
            color: #000;
        }

        /* ‚îÄ‚îÄ SYSTEM UTILITY BUTTONS ‚îÄ‚îÄ */
        .sys-btn {
            position: fixed; z-index: 8000;
            font-size: 26px; cursor: pointer;
            background: rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%; width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }
        #mute-btn { top: calc(var(--safe-top) + 8px); right: 14px; }
        #pause-btn { top: calc(var(--safe-top) + 8px); left: 14px; }

        /* ‚îÄ‚îÄ POWER RING CHARGE INDICATOR ‚îÄ‚îÄ */
        #power-ring-hud {
            position: absolute; top: 8px; right: 8px;
            z-index: 25; display: flex; flex-direction: column;
            align-items: center; gap: 2px;
        }
        #power-ring-label {
            font-size: 7px; font-weight: 900;
            letter-spacing: 1px; color: var(--neon-pink);
            text-transform: uppercase;
        }
        #power-ring-pips {
            display: flex; flex-direction: column; gap: 2px;
        }
        .pip {
            width: 8px; height: 8px; border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: 1.5px solid rgba(255,255,255,0.3);
            transition: background 0.3s, box-shadow 0.3s;
        }
        .pip.active {
            background: var(--neon-pink);
            box-shadow: 0 0 8px var(--neon-pink);
        }

        /* ‚îÄ‚îÄ COMBO BADGE ‚îÄ‚îÄ */
        #combo-badge {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            z-index: 50; pointer-events: none;
            font-size: clamp(28px, 9vw, 48px);
            font-weight: 900; text-transform: uppercase;
            letter-spacing: 2px; white-space: nowrap;
            text-shadow: 0 0 20px currentColor, 0 4px 0 rgba(0,0,0,0.5);
            transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                        opacity 0.4s ease;
        }
        @keyframes comboPop {
            0%   { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            25%  { transform: translate(-50%, -60%) scale(1.2); opacity: 1; }
            70%  { transform: translate(-50%, -65%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -80%) scale(0.8); opacity: 0; }
        }
    </style>
</head>
<body onpointerdown="wakeAudio()">

    <!-- Utility buttons -->
    <div class="sys-btn" id="mute-btn"  onclick="toggleMute()">üîä</div>
    <div class="sys-btn" id="pause-btn" onclick="doPause()">‚è∏</div>

    <!-- Ambient clouds -->
    <div class="cloud" style="width:200px;height:60px;top:12%;animation:drift 40s linear infinite;"></div>
    <div class="cloud" style="width:280px;height:75px;top:38%;animation:drift 58s linear reverse infinite;"></div>
    <div class="cloud" style="width:160px;height:45px;top:65%;animation:drift 34s linear infinite 8s;"></div>

    <!-- ‚ïê‚ïê‚ïê START SCREEN ‚ïê‚ïê‚ïê -->
    <div id="start-screen">
        <div class="start-card">
            <img src="Dante_App_Logo.png" id="start-logo" alt="Dante">
            <h1 id="start-title">DANTE'S RINGS</h1>
            <p id="start-sub">A Future Vibrant Self Adventure</p>
            <button id="start-btn" onclick="startGame()">START ADVENTURE</button>
            <div class="hint-row">
                <div class="hint-chip">üëÜ Tap ‚Üí Rotate</div>
                <div class="hint-chip">üëâ Drag ‚Üí Move</div>
                <div class="hint-chip">üëá Drag Down ‚Üí Drop</div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê HUD ‚ïê‚ïê‚ïê -->
    <div id="hud">
        <p id="world-name">Underwater World</p>
        <div id="hud-stats">
            <span>SCORE <b id="v-score">0</b></span>
            <span>LINES <b id="v-lines">0</b></span>
        </div>
        <div id="progress-wrap"><div id="progress-bar"></div></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê GAME VIEWPORT ‚ïê‚ïê‚ïê -->
    <div id="viewport">
        <!-- Left sidebar: HOLD -->
        <div class="sidebar" id="sidebar-l">
            <span class="sidebar-label">HOLD</span>
            <div class="glass-box">
                <!-- Dante lives here -->
                <div id="dante-wrap">
                    <img src="Dante_App_Logo.png" id="dante-img" alt="Dante">
                    <span id="dante-mood">üòä</span>
                </div>
                <canvas id="hold-canvas" width="50" height="50"></canvas>
            </div>
        </div>

        <!-- THE GRID -->
        <div id="grid-wrap">
            <canvas id="game-canvas" width="300" height="600"></canvas>
            <div id="flash-overlay"></div>

            <!-- Power ring pip display -->
            <div id="power-ring-hud">
                <div id="power-ring-label">‚ö°</div>
                <div id="power-ring-pips">
                    <div class="pip" id="pip4"></div>
                    <div class="pip" id="pip3"></div>
                    <div class="pip" id="pip2"></div>
                    <div class="pip" id="pip1"></div>
                </div>
            </div>

            <!-- Combo badge -->
            <div id="combo-badge"></div>

            <!-- Game state overlay -->
            <div id="overlay">
                <img id="ov-win-img" src="Youwin.png" alt="You Win!">
                <h2 id="ov-title">LEVEL UP!</h2>
                <p  id="ov-body"></p>
                <button class="ov-btn" id="ov-btn" onclick="handleOverlay()">CONTINUE</button>
                <button id="power-btn" onclick="usePowerRing()">‚ö° USE POWER RING</button>
            </div>
        </div>

        <!-- Right sidebar: NEXT -->
        <div class="sidebar" id="sidebar-r">
            <span class="sidebar-label">NEXT</span>
            <div class="glass-box">
                <canvas id="next-canvas" width="50" height="50"></canvas>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê FOOTER CONTROLS ‚ïê‚ïê‚ïê -->
    <div id="footer">
        <div class="foot-btn" id="btn-hold"   onpointerdown="doHold()">
            üì¶<span class="label">Hold</span>
        </div>
        <div class="foot-btn" id="btn-drop"   onpointerdown="doHardDrop()">
            ‚¨áÔ∏è<span class="label">Drop</span>
        </div>
        <div class="foot-btn" id="btn-rotate" onpointerdown="doRotate()">
            üîÑ<span class="label">Rotate</span>
        </div>
    </div>

<script>
/* ================================================================
   DANTE'S RINGS ‚Äî ENGINE v3.0 (VIBRANT REBUILD)
   Future Vibrant Self Adventure
   ================================================================ */

// ‚îÄ‚îÄ WORLD / THEME DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WORLDS = [
    { name:"Underwater World",  bgA:"#001a4d", bgB:"#003380", accent:"#00C8FF",  target:10,  speed:900  },
    { name:"Pandora",           bgA:"#1a004d", bgB:"#3d008f", accent:"#BF00FF",  target:60,  speed:840  },
    { name:"Minecraft",         bgA:"#0a2200", bgB:"#1a4d00", accent:"#7CFC00",  target:90,  speed:780  },
    { name:"Lego World",        bgA:"#4d0000", bgB:"#990000", accent:"#FF3030",  target:120, speed:720  },
    { name:"Rainforest",        bgA:"#001a00", bgB:"#003300", accent:"#00FF88",  target:150, speed:660  },
    { name:"Outer Space",       bgA:"#000010", bgB:"#00001e", accent:"#7B2FFF",  target:180, speed:600  },
    { name:"Jungle",            bgA:"#0d2200", bgB:"#1f4d00", accent:"#AAFF00",  target:210, speed:540  },
    { name:"School",            bgA:"#00234d", bgB:"#003d80", accent:"#FFD600",  target:240, speed:475  },
    { name:"Sun Surface",       bgA:"#4d1500", bgB:"#99300", accent:"#FF6200",  target:270, speed:415  },
    { name:"Dream World",       bgA:"#3d0033", bgB:"#660055", accent:"#FF2D9B",  target:350, speed:360  }
];

const LESSONS = [
    "Level 1: Breathe beneath the surface. Drag to move. Tap to spin. Clear 10 lines to evolve!",
    "Pandora: Dante discovers curiosity. Every colour is a new possibility.",
    "Minecraft: Dante learns he can rebuild anything he breaks, piece by piece.",
    "Lego World: Dante finds joy in play. Structure is the foundation of freedom.",
    "Rainforest: Dante trusts growth he cannot see yet. Keep ascending.",
    "Outer Space: Dante finds stillness in the vast unknown. Float freely.",
    "Jungle: Dante follows instinct. He moves with nature, not against it.",
    "School: Every mis-drop is a lesson waiting to be mastered.",
    "Sun Surface: Hold your shape in the heat of transformation.",
    "Dream World: Dante wakes up inside his imagination. The self is complete."
];

// ‚îÄ‚îÄ PIECE COLOURS ‚Äî NEON ELECTRIC PALETTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// idx 0 = empty, 1-7 = pieces
const COLORS = [
    null,
    '#FF2D9B', // 1 Hot Pink      (has ears)
    '#FFD600', // 2 Electric Gold (has ears)
    '#7B2FFF', // 3 Deep Violet
    '#00C8FF', // 4 Cyan Ice
    '#FF6200', // 5 Blaze Orange
    '#00FF88', // 6 Neon Mint
    '#FF3030'  // 7 Cherry Red
];

// ‚îÄ‚îÄ CANVAS SETUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const COLS = 10, ROWS = 20;
const gameCanvas  = document.getElementById('game-canvas');
const ctx         = gameCanvas.getContext('2d');
const holdCanvas  = document.getElementById('hold-canvas');
const hctx        = holdCanvas.getContext('2d');
const nextCanvas  = document.getElementById('next-canvas');
const nctx        = nextCanvas.getContext('2d');

// Use device pixel ratio for crisp rendering on Retina/ProMotion
function setupCanvas(c, cssW, cssH) {
    const dpr = window.devicePixelRatio || 1;
    c.width  = cssW * dpr;
    c.height = cssH * dpr;
    c.style.width  = cssW + 'px';
    c.style.height = cssH + 'px';
    return c.getContext('2d');
}

// Sidebar canvases ‚Äî small previews
const CELL = 15; // sidebar cell size
const SB_COLS = 4, SB_ROWS = 4;
hctx.scale(CELL, CELL);
nctx.scale(CELL, CELL);

// Main grid scale ‚Äî derive from canvas size
const SCALE = 30; // internal grid units; canvas is 300x600 ‚Üí 10x20 cells
ctx.scale(SCALE, SCALE);

// ‚îÄ‚îÄ AUDIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const bgMusic  = new Audio('Dantesgamemusic.m4a');
bgMusic.loop = true; bgMusic.volume = 0.4;
let audioReady = false, muted = false;

function wakeAudio() {
    if (audioReady) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    audioReady = true;
}
function toggleMute() {
    muted = !muted;
    bgMusic.muted = muted;
    document.getElementById('mute-btn').textContent = muted ? 'üîá' : 'üîä';
}
function sfx(freq, type = 'sine', dur = 0.15, vol = 0.12) {
    if (muted || !audioReady) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + dur);
}
function sfxClear(count) {
    // Ascending chord on multi-clear
    const notes = [523, 659, 784, 1047];
    notes.slice(0, Math.min(count, 4)).forEach((f, i) => {
        setTimeout(() => sfx(f, 'sine', 0.25, 0.15), i * 55);
    });
}
function sfxLevelUp() {
    [523,659,784,1047,1319].forEach((f,i) => setTimeout(() => sfx(f,'square',0.2,0.12), i*80));
}

// ‚îÄ‚îÄ PIECES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function makePiece(t) {
    // Standard orientations (horizontal I, correct Z/S)
    if (t==='I') return [[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]];
    if (t==='O') return [[4,4],[4,4]];
    if (t==='T') return [[0,7,0],[7,7,7],[0,0,0]];
    if (t==='S') return [[0,6,6],[6,6,0],[0,0,0]];
    if (t==='Z') return [[5,5,0],[0,5,5],[0,0,0]];
    if (t==='J') return [[3,0,0],[3,3,3],[0,0,0]];
    if (t==='L') return [[0,0,2],[2,2,2],[0,0,0]];
}
const PIECE_TYPES = 'IOTSZJL';
function randPiece() { return makePiece(PIECE_TYPES[Math.random() * 7 | 0]); }

// Bag randomiser (7-bag system ‚Äî fairer than pure random)
let bag = [];
function nextFromBag() {
    if (!bag.length) bag = [...PIECE_TYPES].sort(() => Math.random() - 0.5);
    return makePiece(bag.pop());
}

// ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let arena, player, pieceNext, pieceHeld;
let canHold, totalLines, score, levelIdx;
let paused, gameOver;
let dropTimer, lastTs, dropInterval;

// Lock delay
let lockTimer = 0;
const LOCK_DELAY = 450;

// Power Ring system
let powerCharges = 0;
const MAX_POWER = 4;

// Combo system
let combo = 0;

// Streak / particles
let particles = [];
let shakeAmt  = 0;

function initState() {
    arena      = Array.from({length: ROWS}, () => Array(COLS).fill(0));
    player     = { pos: {x:0, y:0}, matrix: null, score: 0 };
    pieceNext  = nextFromBag();
    pieceHeld  = null;
    canHold    = true;
    totalLines = 0;
    score      = 0;
    levelIdx   = 0;
    paused     = false;
    gameOver   = false;
    dropTimer  = 0;
    lastTs     = 0;
    dropInterval = WORLDS[0].speed;
    powerCharges = 0;
    combo      = 0;
    particles  = [];
    shakeAmt   = 0;
    bag        = []; // fresh bag
    updateHUD();
    updatePips();
}

// ‚îÄ‚îÄ SPAWN & COLLISION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spawn() {
    player.matrix  = pieceNext;
    pieceNext      = nextFromBag();
    player.pos.y   = 0;
    player.pos.x   = (COLS / 2 | 0) - (player.matrix[0].length / 2 | 0);
    canHold        = true;
    lockTimer      = 0;

    if (collides(arena, player)) {
        triggerGameOver();
    }
}

function collides(board, p) {
    const m = p.matrix, ox = p.pos.x, oy = p.pos.y;
    for (let y = 0; y < m.length; y++) {
        for (let x = 0; x < m[y].length; x++) {
            if (!m[y][x]) continue;
            const ny = y + oy, nx = x + ox;
            if (ny < 0 || ny >= ROWS || nx < 0 || nx >= COLS) return true;
            if (board[ny][nx]) return true;
        }
    }
    return false;
}

// ‚îÄ‚îÄ ROTATION (SRS-LITE) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rotate(matrix) {
    // Transpose + reverse rows = clockwise
    return matrix[0].map((_, i) => matrix.map(row => row[i]).reverse());
}

function tryRotate() {
    const old = player.matrix;
    player.matrix = rotate(player.matrix);
    const kicks = [0, -1, 1, -2, 2];
    for (const k of kicks) {
        player.pos.x += k;
        if (!collides(arena, player)) { sfx(600,'sine',0.06); return; }
        player.pos.x -= k;
    }
    player.matrix = old; // revert
}

// ‚îÄ‚îÄ MERGE & SWEEP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function merge() {
    player.matrix.forEach((row, y) => row.forEach((v, x) => {
        if (v) arena[y + player.pos.y][x + player.pos.x] = v;
    }));
}

function sweep() {
    let cleared = 0;
    for (let y = ROWS - 1; y >= 0; y--) {
        if (arena[y].every(c => c !== 0)) {
            // Spawn particles along cleared row
            for (let x = 0; x < COLS; x++) {
                const col = COLORS[arena[y][x]];
                for (let i = 0; i < 6; i++) {
                    particles.push({
                        x: x + 0.5, y: y + 0.5,
                        vx: (Math.random() - 0.5) * 0.8,
                        vy: (Math.random() - 1.5) * 0.7,
                        life: 1, color: col, size: Math.random() * 0.3 + 0.1
                    });
                }
            }
            arena.splice(y, 1);
            arena.unshift(new Array(COLS).fill(0));
            cleared++;
            y++;
        }
    }
    if (cleared > 0) {
        combo++;
        totalLines += cleared;
        score += [0, 100, 300, 500, 800][Math.min(cleared, 4)] * (combo > 1 ? combo : 1);

        // Power charge
        powerCharges = Math.min(powerCharges + cleared, MAX_POWER);
        updatePips();

        shakeAmt = 18 + cleared * 6;
        sfxClear(cleared);
        flashScreen();
        showCombo(cleared);
        setDanteMood('celebrate');
        updateHUD();
        checkLevelUp();
    } else {
        combo = 0;
        setDanteMood('idle');
    }
}

// ‚îÄ‚îÄ POWER RING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function usePowerRing() {
    if (powerCharges < MAX_POWER) return;
    // Clear the bottom 2 rows
    for (let i = 0; i < 2; i++) {
        arena.pop();
        arena.unshift(new Array(COLS).fill(0));
    }
    // Big particle burst
    for (let y = ROWS - 2; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
            for (let i = 0; i < 8; i++) {
                particles.push({
                    x: x + 0.5, y: y + 0.5,
                    vx: (Math.random() - 0.5) * 1.2,
                    vy: (Math.random() - 2) * 1,
                    life: 1, color: '#FF2D9B', size: 0.35
                });
            }
        }
    }
    powerCharges = 0;
    updatePips();
    sfx(880, 'square', 0.4, 0.2);
    shakeAmt = 30;
    flashScreen('#FF2D9B');
    // Hide the power ring button if on overlay
    document.getElementById('power-btn').style.display = 'none';
    // Resume if paused for game over hint
    if (paused && !gameOver) return;
}

// ‚îÄ‚îÄ HARD DROP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doHardDrop() {
    if (paused || gameOver) return;
    let dropped = 0;
    while (!collides(arena, player)) { player.pos.y++; dropped++; }
    player.pos.y--;
    score += dropped;
    lockAndSpawn();
    sfx(180, 'sine', 0.12);
}

function lockAndSpawn() {
    merge();
    sweep();
    spawn();
    dropTimer = 0;
    lockTimer = 0;
}

// ‚îÄ‚îÄ HOLD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doHold() {
    if (!canHold || paused || gameOver) return;
    if (!pieceHeld) {
        pieceHeld = player.matrix;
        spawn();
    } else {
        [player.matrix, pieceHeld] = [pieceHeld, player.matrix];
        player.pos.y = 0;
        player.pos.x = (COLS / 2 | 0) - (player.matrix[0].length / 2 | 0);
    }
    canHold = false;
    sfx(300, 'sine', 0.12);
}

function doRotate() { if (!paused && !gameOver) tryRotate(); }

// ‚îÄ‚îÄ GHOST PIECE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ghostY() {
    let gy = player.pos.y;
    while (!collides(arena, { matrix: player.matrix, pos: { x: player.pos.x, y: gy + 1 } })) gy++;
    return gy;
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawRing(c, px, py, colorIdx, ghost = false, ears = false) {
    if (!COLORS[colorIdx]) return;
    const base = COLORS[colorIdx];
    const cx = px + 0.5, cy = py + 0.5;

    c.globalAlpha = ghost ? 0.28 : 1;

    // Ears (Hello Kitty style) on pieces 1 & 2
    if (ears && !ghost) {
        c.fillStyle = base;
        c.beginPath(); c.arc(cx - 0.25, cy - 0.36, 0.17, 0, Math.PI * 2); c.fill();
        c.beginPath(); c.arc(cx + 0.25, cy - 0.36, 0.17, 0, Math.PI * 2); c.fill();
        // inner ear lighter
        c.fillStyle = 'rgba(255,255,255,0.4)';
        c.beginPath(); c.arc(cx - 0.25, cy - 0.36, 0.09, 0, Math.PI * 2); c.fill();
        c.beginPath(); c.arc(cx + 0.25, cy - 0.36, 0.09, 0, Math.PI * 2); c.fill();
    }

    // Main circle
    c.beginPath(); c.arc(cx, cy, 0.43, 0, Math.PI * 2);

    if (ghost) {
        c.strokeStyle = base;
        c.lineWidth = 0.07;
        c.stroke();
    } else {
        // Candy gloss gradient
        const g = c.createRadialGradient(cx - 0.12, cy - 0.14, 0.04, cx, cy, 0.46);
        g.addColorStop(0,    'rgba(255,255,255,0.95)');
        g.addColorStop(0.25, base);
        g.addColorStop(0.75, base);
        g.addColorStop(1,    'rgba(0,0,0,0.5)');
        c.fillStyle = g;
        c.fill();

        // Shine stroke
        c.strokeStyle = 'rgba(255,255,255,0.7)';
        c.lineWidth = 0.065;
        c.stroke();

        // Specular highlight dot
        c.beginPath(); c.arc(cx - 0.13, cy - 0.14, 0.1, 0, Math.PI * 2);
        c.fillStyle = 'rgba(255,255,255,0.55)';
        c.fill();
    }

    c.globalAlpha = 1;
}

function drawMatrix(c, matrix, pos, ghost = false) {
    if (!matrix) return;
    matrix.forEach((row, y) => row.forEach((v, x) => {
        if (v) {
            const ears = (v === 1 || v === 2);
            drawRing(c, x + pos.x, y + pos.y, v, ghost, ears);
        }
    }));
}

// World background gradient
function drawBg() {
    const w = WORLDS[levelIdx];
    const grad = ctx.createLinearGradient(0, 0, 0, ROWS);
    grad.addColorStop(0, w.bgA);
    grad.addColorStop(1, w.bgB);
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, COLS, ROWS);
}

// Subtle grid lines
function drawGrid() {
    ctx.strokeStyle = 'rgba(255,255,255,0.10)';
    ctx.lineWidth = 0.03;
    for (let x = 0; x <= COLS; x++) {
        ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, ROWS); ctx.stroke();
    }
    for (let y = 0; y <= ROWS; y++) {
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(COLS, y); ctx.stroke();
    }
}

// Particles
function updateParticles() {
    for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.x  += p.vx;
        p.y  += p.vy;
        p.vy += 0.04; // gravity
        p.life -= 0.03;
        if (p.life <= 0) { particles.splice(i, 1); }
    }
}

function drawParticles() {
    particles.forEach(p => {
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
    });
    ctx.globalAlpha = 1;
}

// Sidebar previews
function drawSidebar(c, matrix) {
    c.clearRect(0, 0, SB_COLS, SB_ROWS);
    if (!matrix) return;
    // Centre small piece in the 4x4 preview
    const offX = ((SB_COLS - matrix[0].length) / 2) | 0;
    const offY = ((SB_ROWS - matrix.length)    / 2) | 0;
    drawMatrix(c, matrix, {x: offX, y: offY});
}

function render() {
    // Shake offset
    let ox = 0, oy = 0;
    if (shakeAmt > 0) {
        ox = (Math.random() - 0.5) * shakeAmt * 0.2;
        oy = (Math.random() - 0.5) * shakeAmt * 0.2;
        shakeAmt *= 0.78;
        if (shakeAmt < 0.5) shakeAmt = 0;
    }

    ctx.save();
    ctx.translate(ox, oy);

    drawBg();
    drawGrid();

    // Static arena
    drawMatrix(ctx, arena, {x: 0, y: 0});

    if (player.matrix) {
        // Ghost
        drawMatrix(ctx, player.matrix, {x: player.pos.x, y: ghostY()}, true);
        // Active piece
        drawMatrix(ctx, player.matrix, player.pos);
    }

    // Particles
    updateParticles();
    drawParticles();

    ctx.restore();

    // Sidebar previews (unaffected by shake)
    drawSidebar(nctx, pieceNext);
    drawSidebar(hctx, pieceHeld);
}

// ‚îÄ‚îÄ MAIN LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tick(ts = 0) {
    if (paused || gameOver) return;

    const dt = ts - lastTs;
    lastTs = ts;
    dropTimer += dt;

    if (dropTimer > dropInterval) {
        player.pos.y++;
        if (collides(arena, player)) {
            player.pos.y--;
            lockTimer += dropInterval;
            if (lockTimer >= LOCK_DELAY) {
                lockAndSpawn();
            }
        } else {
            lockTimer = 0;
        }
        dropTimer = 0;
    }

    render();
    requestAnimationFrame(tick);
}

// ‚îÄ‚îÄ HUD & LEVEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateHUD() {
    document.getElementById('v-score').textContent = score;
    document.getElementById('v-lines').textContent = totalLines;
    document.getElementById('world-name').textContent = WORLDS[levelIdx].name;
    document.getElementById('world-name').style.color = WORLDS[levelIdx].accent;
    document.getElementById('world-name').style.textShadow = `0 0 20px ${WORLDS[levelIdx].accent}`;

    const prev   = levelIdx > 0 ? WORLDS[levelIdx - 1].target : 0;
    const curr   = WORLDS[levelIdx].target;
    const pct    = Math.min(100, Math.max(0, (totalLines - prev) / (curr - prev) * 100));
    document.getElementById('progress-bar').style.width = pct + '%';
    document.getElementById('progress-bar').style.background =
        `linear-gradient(90deg, ${WORLDS[levelIdx].accent}, #ffffff44)`;
}

function checkLevelUp() {
    const w = WORLDS[levelIdx];
    if (levelIdx === WORLDS.length - 1 && totalLines >= w.target) {
        showOverlay('DREAM WORLD!', LESSONS[levelIdx], true);
        return;
    }
    if (totalLines >= w.target && levelIdx < WORLDS.length - 1) {
        levelIdx++;
        dropInterval = WORLDS[levelIdx].speed;
        sfxLevelUp();
        updateHUD();
        showOverlay(WORLDS[levelIdx].name, LESSONS[levelIdx], false);
    }
}

// ‚îÄ‚îÄ OVERLAY SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let overlayMode = ''; // 'continue' | 'restart' | 'win'

function showOverlay(title, body, win) {
    paused = true;
    bgMusic.pause();
    document.getElementById('ov-title').textContent = title;
    document.getElementById('ov-body').textContent  = body;
    document.getElementById('ov-win-img').style.display = win ? 'block' : 'none';

    if (win) {
        overlayMode = 'win';
        document.getElementById('ov-btn').textContent = 'üéâ PLAY AGAIN';
        setDanteMood('win');
    } else if (title === 'STACKED OUT!') {
        overlayMode = 'restart';
        document.getElementById('ov-btn').textContent = 'üîÑ TRY AGAIN';
        // Show power ring offer if charged
        const pb = document.getElementById('power-btn');
        pb.style.display = powerCharges >= MAX_POWER ? 'block' : 'none';
        setDanteMood('sad');
    } else {
        overlayMode = 'continue';
        document.getElementById('ov-btn').textContent = '‚ñ∂ CONTINUE';
    }

    document.getElementById('overlay').style.display = 'flex';
}

function handleOverlay() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('power-btn').style.display = 'none';
    if (overlayMode === 'continue') {
        paused = false;
        if (!muted) bgMusic.play();
        requestAnimationFrame(tick);
    } else {
        // restart or win ‚Üí full reset
        bag = [];
        initState();
        spawn();
        if (!muted) bgMusic.play().catch(()=>{});
        requestAnimationFrame(tick);
    }
}

function triggerGameOver() {
    gameOver = true;
    sfx(150, 'sawtooth', 0.8);
    showOverlay('STACKED OUT!', 'Breathe. Notice the pattern you\'re building.', false);
}

function doPause() {
    if (gameOver) return;
    if (!paused) {
        showOverlay('PAUSED ‚è∏', 'Take a breath. Come back when ready.', false);
        overlayMode = 'continue';
    }
}

// ‚îÄ‚îÄ DANTE EXPRESSIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MOODS = {
    idle:      'üòä',
    nervous:   'üò∞',
    celebrate: 'üéâ',
    sad:       'üò¢',
    win:       'üåü'
};
let moodTimeout = null;

function setDanteMood(mood) {
    const el = document.getElementById('dante-mood');
    const wrap = document.getElementById('dante-wrap');
    el.textContent = MOODS[mood] || 'üòä';

    if (mood === 'celebrate') {
        wrap.style.transform = 'translateX(-50%) scale(1.5) translateY(-20px)';
        setTimeout(() => { wrap.style.transform = 'translateX(-50%)'; }, 500);
    } else if (mood === 'win') {
        wrap.style.transform = 'translateX(-50%) rotate(15deg) scale(1.4)';
    } else if (mood === 'sad') {
        wrap.style.transform = 'translateX(-50%) scale(0.85) translateY(8px)';
    } else {
        wrap.style.transform = 'translateX(-50%)';
    }

    // Stack danger mood: turn nervous when arena is 60%+ full
    clearTimeout(moodTimeout);
    if (mood === 'idle' || mood === 'celebrate') {
        moodTimeout = setTimeout(() => checkStackDanger(), 800);
    }
}

function checkStackDanger() {
    // Count filled cells in top half
    let filled = 0;
    for (let y = 0; y < ROWS / 2; y++) {
        for (let x = 0; x < COLS; x++) {
            if (arena[y][x]) filled++;
        }
    }
    if (filled > (ROWS / 2) * COLS * 0.3) {
        document.getElementById('dante-mood').textContent = MOODS.nervous;
    }
}

// ‚îÄ‚îÄ POWER RING PIPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updatePips() {
    for (let i = 1; i <= MAX_POWER; i++) {
        const pip = document.getElementById('pip' + i);
        pip.classList.toggle('active', i <= powerCharges);
    }
}

// ‚îÄ‚îÄ FLASH & COMBO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function flashScreen(color = 'rgba(255,255,255,0.5)') {
    const f = document.getElementById('flash-overlay');
    f.style.background = color;
    f.style.opacity    = '1';
    setTimeout(() => { f.style.opacity = '0'; }, 80);
}

const COMBO_MSGS = ['', 'NICE! +100', 'GREAT! +300', 'AMAZING! +500', 'TETRIS! +800'];
const COMBO_COLORS = ['', '#00FF88', '#FFD600', '#FF6200', '#FF2D9B'];

function showCombo(cleared) {
    const badge = document.getElementById('combo-badge');
    const msg   = combo > 1 ? `COMBO x${combo}! üî•` : (COMBO_MSGS[Math.min(cleared, 4)] || '');
    badge.textContent  = msg;
    badge.style.color  = combo > 1 ? '#FF2D9B' : COMBO_COLORS[Math.min(cleared, 4)];
    badge.style.animation = 'none';
    badge.offsetHeight; // reflow
    badge.style.animation = 'comboPop 1.1s ease forwards';
}

// ‚îÄ‚îÄ TOUCH CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let touchX0, touchY0, touchMoved;
const gameWrap = document.getElementById('grid-wrap');

gameWrap.addEventListener('touchstart', e => {
    if (paused || gameOver) return;
    touchX0    = e.touches[0].clientX;
    touchY0    = e.touches[0].clientY;
    touchMoved = false;
}, { passive: false });

gameWrap.addEventListener('touchmove', e => {
    if (paused || gameOver) return;
    e.preventDefault();
    const dx = e.touches[0].clientX - touchX0;
    const dy = e.touches[0].clientY - touchY0;

    if (Math.abs(dx) > 10 || Math.abs(dy) > 10) touchMoved = true;

    // Horizontal step
    if (Math.abs(dx) > 32) {
        const dir = dx > 0 ? 1 : -1;
        player.pos.x += dir;
        if (collides(arena, player)) player.pos.x -= dir;
        else sfx(400, 'sine', 0.04);
        touchX0 = e.touches[0].clientX;
    }

    // Soft drop
    if (dy > 55) {
        dropInterval = 40;
    }
}, { passive: false });

gameWrap.addEventListener('touchend', () => {
    if (paused || gameOver) return;
    if (!touchMoved) tryRotate();
    dropInterval = WORLDS[levelIdx].speed;
});

// Keyboard controls (desktop fallback)
document.addEventListener('keydown', e => {
    if (paused || gameOver) return;
    if (e.key === 'ArrowLeft')  { player.pos.x--; if (collides(arena, player)) player.pos.x++; else sfx(400,'sine',0.04); }
    if (e.key === 'ArrowRight') { player.pos.x++; if (collides(arena, player)) player.pos.x--; else sfx(400,'sine',0.04); }
    if (e.key === 'ArrowDown')  { dropInterval = 60; }
    if (e.key === 'ArrowUp' || e.key === 'x') tryRotate();
    if (e.key === ' ')          doHardDrop();
    if (e.key === 'h' || e.key === 'H' || e.key === 'Shift') doHold();
    if (e.key === 'p' || e.key === 'P') doPause();
    if (e.key === 'q' && powerCharges >= MAX_POWER) usePowerRing();
});
document.addEventListener('keyup', e => {
    if (e.key === 'ArrowDown') dropInterval = WORLDS[levelIdx].speed;
});

// ‚îÄ‚îÄ START GAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startGame() {
    wakeAudio();
    document.getElementById('start-screen').style.display = 'none';
    initState();
    spawn();
    if (!muted) bgMusic.play().catch(() => {});
    requestAnimationFrame(tick);
}

// Initial static render so canvas isn't blank before start
(function preRender() {
    // Draw a silent grid with the first world colors
    const w = WORLDS[0];
    const grad = ctx.createLinearGradient(0, 0, 0, ROWS);
    grad.addColorStop(0, w.bgA);
    grad.addColorStop(1, w.bgB);
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, COLS, ROWS);
    ctx.strokeStyle = 'rgba(255,255,255,0.10)';
    ctx.lineWidth = 0.03;
    for (let x = 0; x <= COLS; x++) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,ROWS); ctx.stroke(); }
    for (let y = 0; y <= ROWS; y++) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(COLS,y); ctx.stroke(); }
})();
</script>
</body>
</html>
